<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loading Quiz...</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4B6V3MV51Q"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date());
Â  gtag('config', 'G-4B6V3MV51Q');
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/auth.js"></script>
<style>

/* =========================================
Â  Â 1. GLOBAL VARIABLES & RESET
Â  Â ========================================= */
:root {
Â  --accent: #0b5ed7;Â  Â  Â  Â /* Testbook Blue */
Â  --accent-dark: #094bc0;
Â  --success: #198754;Â  Â  Â  /* Green */
Â  --danger: #dc3545;Â  Â  Â  Â /* Red */
Â  --warning: #ffc107;Â  Â  Â  /* Yellow/Orange */
Â  --muted: #6c757d;
Â  --bg-color: #ffffff;Â  Â  Â /* Solid White Background */
Â  --light-gray: #f5f7fa;
Â  --border-color: #e0e0e0;
Â  --max-width: 1280px;Â  Â  Â /* Wider for Desktop */
Â  --header-height: 60px;
}

* { box-sizing: border-box; }

body {
Â  margin: 0;
Â  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
Â  background: var(--bg-color);
Â  color: #212121;
Â  padding-bottom: 60px; /* Space for mobile bottom bar */
Â  -webkit-user-select: none; /* Security */
Â  -moz-user-select: none;
Â  user-select: none;
}

/* Allow text selection in inputs */
input, textarea { user-select: text !important; }

Â  /* Hide auth.js top bar only on this page */
.fixed-top-bar { display: none !important; }
body { padding-top: 0 !important; }

/* Beautiful Username Box */
.header-username-box {
Â  background: rgba(11, 94, 215, 0.1);
Â  color: var(--accent);
Â  padding: 4px 12px;
Â  border-radius: 6px;
Â  font-size: 13px;
Â  font-weight: 700;
Â  border: 1px solid rgba(11, 94, 215, 0.2);
Â  margin-left: 10px;
Â  display: inline-flex;
Â  align-items: center;
}
/* =========================================
Â  Â 2. LAYOUT CONTAINERS
Â  Â ========================================= */
.container {
Â  max-width: var(--max-width);
Â  margin: auto;
Â  padding: 12px 16px;
}

/* Wrapper for Quiz vs Palette Layout */
.quiz-main-area {
Â  display: block; /* Default mobile: Stacked */
Â  position: relative;
}

/* =========================================
Â  Â 3. HEADER (Timer & Top Actions)
Â  Â ========================================= */
header {
Â  background: #fff;
Â  border-bottom: 1px solid var(--border-color);
Â  position: sticky;
Â  top: 0;
Â  z-index: 100;
Â  height: var(--header-height);
}

/* UPDATED: Title starts from exact left */
.header-inner {
Â  display: flex;
Â  align-items: center;
Â  justify-content: space-between;
Â  height: 100%;
Â  padding: 0 16px 0 0; /* Remove left padding (Top Right Bottom Left) */
Â  max-width: none;Â  Â  Â /* Allow it to touch the edge on wide screens */
Â  margin: 0;Â  Â  Â  Â  Â  Â /* Remove auto-centering margin */
}

h1 {
Â  margin: 0;
Â  color: var(--accent);
Â  font-size: 18px;
Â  font-weight: 700;
Â  padding-left: 10px; /* Small breathing room from the screen edge */
}

@media (min-width: 992px) {
Â  /* Ensure the container doesn't force a center gap on very wide screens */
Â  .header-inner {
Â  Â  max-width: none;Â 
Â  Â  width: 100%;
Â  }
}
/* Timer Text */
.timer-text {
Â  font-variant-numeric: tabular-nums;
Â  font-weight: 700;
Â  font-size: 18px;
Â  color: #333;
Â  background: #f0f2f5;
Â  padding: 4px 12px;
Â  border-radius: 4px;
}

/* Desktop Actions Container (Hidden on Mobile) */
.top-actions {
Â  display: none;
Â  gap: 8px;
}
/* Updated to match image: Blue background, White text, Rounded corners */
.btn, .btn-ghost {
Â  background: #0b5ed7 !important; /* Solid Blue as per image */
Â  color: #fff !important;
Â  border: none !important;
Â  border-radius: 8px !important; /* Rounded corners */
Â  padding: 10px 20px;
Â  font-size: 14px;
Â  font-weight: 700; /* Bold white text */
Â  cursor: pointer;
Â  transition: 0.2s;
Â  display: inline-flex;
Â  align-items: center;
Â  justify-content: center;
Â  white-space: nowrap;
}

.btn:hover, .btn-ghost:hover {
Â  background: #094bc0 !important;
Â  opacity: 0.9;
}

/* =========================================
Â  Â 4. WELCOME SCREEN (Continuous Page Layout)
Â  Â ========================================= */
.welcome-screen {
Â  position: fixed;
Â  inset: 0;
Â  background: #ffffff;
Â  z-index: 2000;
Â  display: flex;
Â  flex-direction: column;Â 
Â  padding: 0;
Â  overflow-y: auto; /* ENTIRE page now handles the scrolling */
}

.welcome-container {
Â  /* Removed flex: 1 and overflow-y: auto to allow natural page flow */
Â  width: 100%;
Â  max-width: 1000px;
Â  margin: 0 auto;
Â  padding: 20px 20px 100px 20px; /* Extra bottom padding so content isn't hidden by fixed footer */
}

.welcome-header { text-align: center; margin-bottom: 24px; }
.welcome-header h1 { font-size: 28px; color: #d32f2f; margin-bottom: 8px; }

/* Dedicated Scrolling removed - Box now expands with content */
.welcome-instructions {
Â  background: #f9f9f9;
Â  border: 1px solid #ddd;
Â  border-radius: 8px;
Â  padding: 25px;
Â  margin-bottom: 20px;
Â  /* Removed max-height and overflow-y to make it a continuous page */
}

/* RESTORED: Boxed Test Details Styling */
.test-details {
Â  display: grid;
Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  gap: 15px;
Â  margin-bottom: 24px;
}
.detail-item {
Â  background: #f8fbff;
Â  border: 1px solid #e1ecff;
Â  padding: 15px;
Â  border-radius: 10px;
Â  text-align: center;
Â  box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

/* Legend Symbol Styles */
.symbol-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin: 15px 0; }
.symbol-item { display: flex; align-items: center; gap: 10px; font-size: 13px; }
.leg-box {Â 
Â  width: 42px; height: 35px; display: flex; align-items: center; justify-content: center;Â 
Â  font-weight: 700; color: #fff; border-radius: 2px; position: relative;Â 
}
.leg-current { background: #dc3545; clip-path: polygon(0% 0%, 100% 0%, 100% 70%, 50% 100%, 0% 70%); }
.leg-answered { background: #198754; }
.leg-notvisited { background: #bdbdbd; color: #000; border: 1px solid #ababab; }
.leg-marked { background: #0b5ed7; }
.leg-marked-ans { background: #0b5ed7; }
.leg-marked-ans::after { content: "â˜…"; position: absolute; bottom: -2px; right: 1px; color: #ffeb3b; font-size: 14px; }

/* FIXED BOTTOM BAR (Testbook Style) */
.welcome-footer {
Â  background: #fff;
Â  border-top: 1px solid #ddd;
Â  padding: 15px 20px;
Â  display: flex;
Â  align-items: center;
Â  justify-content: space-between;
Â  gap: 15px;
Â  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
Â  position: sticky; /* Keeps it at the bottom of the screen while scrolling */
Â  bottom: 0;
Â  width: 100%;
Â  z-index: 2001;
}

.start-btn {
Â  background: #1a73e8;
Â  color: #fff;
Â  border: none;
Â  padding: 10px 30px;
Â  border-radius: 4px;
Â  font-size: 16px;
Â  font-weight: 700;
Â  cursor: pointer;
}

.back-btn {
Â  background: #ff9800;
Â  color: #fff;
Â  border: none;
Â  padding: 10px 25px;
Â  border-radius: 4px;
Â  font-weight: 700;
Â  cursor: pointer;
}

.channel-link-top {
Â  display: inline-block;
Â  padding: 10px 20px;
Â  background: #0088cc;
Â  color: #fff;
Â  border-radius: 5px;
Â  text-decoration: none;
Â  font-weight: 700;
Â  margin-bottom: 20px;
}
/* =========================================
Â  Â 5. QUIZ CARD & QUESTIONS (TESTBOOK STYLE)
Â  Â ========================================= */

/* Quiz card with its OWN scrollbar */
.card {
Â  background: #ffffff;
Â  border: 1px solid #d6d6d6;
Â  border-radius: 4px;
Â  padding: 0;
Â  margin-bottom: 20px;
Â  overflow-y: scroll;

Â  /* ğŸ‘‡ separate scrollbar ALWAYS */
Â  max-height: calc(100vh - 140px);
Â Â 
}

/* =========================
Â  Â BOX 1: META ROW
Â  Â ========================= */
.qbar {
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;

Â  padding: 10px 14px;
Â  border-bottom: 1px solid #d6d6d6;
Â  background: #fff;
}

.qmeta {
Â  font-size: 14px;
Â  font-weight: 600;
Â  color: #555;
}

.marking {
Â  font-size: 13px;
Â  font-weight: 600;
Â  color: #333;
}

/* =========================
Â  Â BOX 2: QUESTION TEXT
Â  Â ========================= */
.qtext {
Â  padding: 12px 14px;
Â  font-size: 17px;
Â  line-height: 1.6;
Â  color: #222;
Â  font-weight: 500;

Â  border-bottom: 1px solid #d6d6d6;
Â  background: #fff;
}

/* =========================
Â  Â BOX 3: OPTIONS TABLE
Â  Â ========================= */

/* Option row */
.opt {
Â  display: grid;
Â  grid-template-columns: 48px 1fr;

Â  border-bottom: 1px solid #d6d6d6;
Â  background: #fff;
Â  margin: 0;
}



/* Selected radio */
.opt.selected .custom-radio::before {
Â  border-color: var(--accent);
Â Â 
}


.opt-text {
Â  padding: 10px 14px;
Â  font-size: 15px;
Â  color: #222;
Â  display: block;Â  Â  Â  Â  /* âœ… REQUIRED */
Â  line-height: 1.6;
}


/* Radio container MUST be positioning context */
.custom-radio {
Â  position: relative;Â  Â /* ğŸ”¥ MOST IMPORTANT LINE */
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;

Â  border-right: 1px solid #d6d6d6;
Â  cursor: pointer;

Â  width: 100%;
Â  height: 100%;
Â  min-height: 42px;

Â  border-radius: 0;
}

/* Outer circle */
.custom-radio::before {
Â  content: "";
Â  width: 18px;
Â  height: 18px;
Â  border: 2px solid #757575;
Â  border-radius: 50%;
}

/* Selected inner dot */
.opt.selected .custom-radio::after {
Â  content: "";
Â  position: absolute;Â  Â /* now relative to .custom-radio */
Â  width: 10px;
Â  height: 10px;
Â  background: var(--accent);
Â  border-radius: 50%;
}
/* Selected row background */
.opt.selected {
Â  background: #eef5ff;
}



/* Solution Explanation Box */
.explanation {
Â  background: #f0f7ff;
Â  border-left: 4px solid var(--accent);
Â  padding: 15px;
Â  margin-top: 20px;
Â  border-radius: 4px;
Â  display: none; /* Hidden by default */
Â  font-size: 14px;
Â  line-height: 1.5;
}

Â  Â  /* =========================
Â  Â SOLUTION MODE â€“ STRONGER COLORS
Â  Â ========================= */

/* Correct answer */
body.mode-solution .opt.correct {
Â  background: #dff5e7;Â  Â  Â  Â  Â  Â  /* deeper green tint */
}

body.mode-solution .opt.correct .custom-radio::before {
Â  border-color: #198754;
Â  background: #198754;
}

/* Wrong selected answer */
body.mode-solution .opt.wrong {
Â  background: #fde2e2;Â  Â  Â  Â  Â  Â  /* deeper red tint */
}
body.mode-solution .opt.wrong .custom-radio::before {
Â  border-color: #dc3545;
Â  background: #dc3545;
}
/* ===============================
Â  Â DESKTOP: RADIO ONLY SELECTION
Â  Â =============================== */
@media (hover: hover) and (pointer: fine) {
Â  .opt {
Â  Â  pointer-events: none;Â  Â  Â  Â  /* âŒ disable box clicks */
Â  }

Â  .custom-radio {
Â  Â  pointer-events: auto;Â  Â  Â  Â  /* âœ… enable radio only */
Â  Â  cursor: pointer;
Â  }
}

/* =========================================
Â  Â 6. VIEW PALETTE (Right Side)
Â  Â ========================================= */
#palette {
Â  background: #dae5f0 !important;
Â Â 
Â  border-radius: 8px;
Â  display: none; /* Hidden on mobile by default */
Â  flex-direction: column;
Â  padding: 15px;
Â  z-index: 1000;
}

/* Palette Header/Legend */
#palette-legend {
Â  display: grid;
Â  grid-template-columns: 1fr 1fr;
Â  gap: 8px;
Â  padding-bottom: 12px;
Â  border-bottom: 1px solid #eee;
Â  margin-bottom: 12px;
Â  font-size: 12px;
}
.lg-box { width: 12px; height: 12px; border-radius: 2px; display: inline-block; vertical-align: middle; margin-right: 4px; }

/* Palette Button Grid */
.palette-grid {
Â  display: flex;
Â  flex-wrap: wrap;
Â  gap: 8px;
Â  align-content: flex-start;
}
/* Palette grid scroll only */
#palette-grid {
Â  overflow-y: auto;
Â  max-height: calc(100vh - 220px);
Â  padding-right: 4px;
Â  overscroll-behavior: contain;
}


Â .qbtn {
Â  /* Shape and Size */
Â  position: relative !important; /* REQUIRED for the star to stay inside */
Â  width: 42px;Â 
Â  height: 35px;
Â  border-radius: 2px; /* Very slight rounding as seen in SS */
Â Â 
Â  /* Color and Background (The Gradient) */
Â  background: linear-gradient(to bottom, #ffffff 0%, #f2f2f2 100%);Â 
Â  border: 1px solid #ababab; /* The grey border from your image */
Â Â 
Â  /* Text Style */
Â  color: #000000;
Â  font-weight: 700;
Â Â 
Â  /* The "Lifted" Effect */
Â  box-shadow: inset 0 1px 0 #fff, 0 1px 2px rgba(0,0,0,0.1);
}Â 
.qbtn:hover { background: #e0e0e0; }
/* Pentagon shape (both modes) */
.qbtn.current {
Â  clip-path: polygon(0% 0%, 100% 0%, 100% 70%, 50% 100%, 0% 70%);
Â  Â 
Â  border: none;
Â  position: relative;
}

/* ğŸ”´ Red outline ONLY in QUIZ MODE */
body.mode-quiz .qbtn.current::before {
Â  content: "";
Â  position: absolute;
Â  inset: -3px;
Â  background: #dc3545;
Â  clip-path: inherit;
Â  z-index: -1;
}

/* âŒ NO outline in solution mode */
body.mode-solution .qbtn.current::before {
Â  content: none;
}


/* --- QUIZ MODE COLORS --- */
.qbtn.answered { background: var(--success); color: #fff; border-color: var(--success); }
.qbtn.marked { background: var(--accent); color: #fff; border-color: var(--accent); }
.qbtn.notvisited {
Â  background: #bdbdbd;Â  /* darker dense grey */
Â  color: #000;
}
.qbtn.marked-answered {
Â  background: var(--accent);
Â  color: #fff;
}
/* Updated Star Positioning - Sit exactly in the corner of the button */
.qbtn.marked-answered::after {
Â  content: "â˜…";
Â  position: absolute;
Â  bottom: -2px;Â  Â /* Adjusted to sit on the bottom edge */
Â  right: 1px;Â  Â  Â /* Adjusted to sit on the right edge */
Â  font-size: 14px;
Â  color: #ffeb3b; /* Bright Yellow Star */
Â  text-shadow: 0 1px 2px rgba(0,0,0,0.8);
Â  line-height: 1;
Â  z-index: 5;
}

.lg-box.notvisited { background: #e0e0e0; }
.lg-box.answered { background: var(--success); }
.lg-box.marked { background: var(--accent); }
.lg-box.marked-answered { background: var(--accent); } /* Legend hack */

/* --- SOLUTION MODE COLORS (New Requirement) --- */
.qbtn.sol-right { background: var(--success); color: #fff; border-color: var(--success); }
.qbtn.sol-wrong { background: var(--danger); color: #fff; border-color: var(--danger); }
.qbtn.sol-skipÂ  { background: #9e9e9e; color: #fff; border-color: #9e9e9e; }

/* Star Indicators for Solution Mode */
.qbtn.sol-right.has-star::after,
.qbtn.sol-wrong.has-star::after {
Â  content: "â˜…";
Â  position: absolute;
Â  bottom: 0px;
Â  font-size: 12px;
Â  color: #ffeb3b;
Â  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
/* =========================================
Â  Â 7. BOTTOM NAVIGATION BAR (Mobile)
Â  Â ========================================= */
.fbar {
Â  position: fixed;
Â  bottom: 0;
Â  left: 0;
Â  right: 0;
Â  background: #fff;
Â  border-top: 1px solid #ddd;
Â  padding: 10px;
Â  display: flex;
Â  justify-content: space-between;
Â  gap: 8px;
Â  z-index: 900;
}

/* Force all bottom buttons to look like the blue image */
.fbar button {
Â  flex: 1;
Â  padding: 12px 4px;
Â  font-size: 13px;
Â  border-radius: 8px; /* Matching image */
Â  background: #0b5ed7;
Â  color: #fff;
Â  border: none;
Â  font-weight: 700;
}

/* Specific logic for Mark button color toggle */
#markBtn.active-mark {Â 
Â  background: #198754 !important; /* Green when active */
}


@media (min-width: 992px) {

Â  /* ===============================
Â  Â  Â GLOBAL DESKTOP WIDTH RESET
Â  Â  Â =============================== */

Â  .container {
Â  Â  max-width: none;
Â  Â  width: 100%;
Â  Â  padding-right: 0;
Â  }

Â  /* ===============================
Â  Â  Â PALETTE (RIGHT FIXED)
Â  Â  Â =============================== */

Â  #palette {
Â  Â  display: flex !important;
Â  Â  position: fixed;
Â  Â  top: var(--header-height);
Â  Â  right: 0;
Â  Â  width: 360px;
Â  Â  height: calc(100vh - var(--header-height));
Â  Â  background: #dae5f0 !important;
Â  Â  border-left: 1px solid var(--border-color);
Â  Â  border-radius: 0;
Â  Â  overflow-y: auto;
Â  Â  z-index: 50;
Â  }

Â  /* ===============================
Â  Â  Â QUIZ AREA (LEFT CONTENT)
Â  Â  Â =============================== */

Â  /* Leave space for palette + small gap */
Â  .quiz-main-area {
Â  Â  margin-right: 372px; /* 360 + 12 gap */
Â  }

Â  /* Quiz card should stretch fully */
Â  #quizCard {
Â  Â  max-width: none;
Â  Â  margin-right: 12px;Â  Â /* ğŸ‘ˆ visual gap from palette */
Â  Â  border-radius: 8px;
Â  }

Â 

Â  /* ===============================
Â  Â  Â SECTION BUTTON ALIGNMENT
Â  Â  Â =============================== */
#sectionNav {
Â  Â  max-width: none;
Â  Â  margin-left: 0;Â  Â  Â  Â  /* Changed from auto to 0 for better sticky alignment */
Â  Â  margin-right: 372px;Â  Â /* Keeps the gap for the desktop palette */
Â  Â  padding-left: 16px;
Â  Â  padding-right: 16px;
Â  Â  Â overflow-x: auto;Â 
Â  Â  /* ğŸ”¥ Sticky Logic ğŸ”¥ */
Â  Â  position: sticky;
Â  Â  top: var(--header-height); /* Sticks exactly below the 60px header */
Â  Â  z-index: 99;Â  Â  Â  Â  Â  Â  Â  Â /* Stays above content but below header */
Â  Â  background: #fff;Â  Â  Â  Â  Â  /* Ensures question text doesn't show through the bar */
Â  }



Â  /* Desktop specific Submit Button inside Palette */
Â  #palette #submitBtn {
Â  Â  display: block !important;
Â  Â  width: 95%;
Â  Â  margin: 20px auto 10px auto; /* Centered with top margin */
Â  Â  background: #1a73e8;
Â  Â  color: white;
Â  Â  font-weight: 700;
Â  Â  padding: 12px;
Â  Â  border-radius: 4px;
Â  Â  border: none;
Â  Â  cursor: pointer;
Â  Â  box-shadow: inset 0 -3px 0 rgba(0,0,0,0.15);
Â  }

Â  /* Hide the original header submit button on desktop since it's now in palette */
Â  header #submitBtn { display: none !important; }

Â  /* 3. Hide Mobile Bottom Bar */
Â  .fbar { display: none !important; }


Â  .top-actions {Â 
Â  Â  display: flex !important;Â 
Â  Â  gap: 10px;
Â  Â  align-items: center;
Â  }

Â  .top-actions .btn,
Â  .top-actions .btn-ghost {
Â  Â  padding: 12px 18px;
Â  Â  font-size: 14px;
Â  Â  font-weight: 700;
Â  Â  border-radius: 8px; /* Matching image */
Â  Â  min-width: 120px;
Â  Â  background: #0b5ed7 !important;
Â  Â  color: #fff !important;
Â  }

Â  /* Keep the Mark button color changing on desktop too */
Â  #markBtn.active-mark {Â 
Â  Â  background: #198754 !important;Â 
Â  }

Â  /* 5. Hide Mobile "View" Toggle in Header */
Â  #paletteBtn { display: none !important; }
}

/* MOBILE LAYOUT */
@media (max-width: 991px) {
Â  /* Palette is a popup overlay */
Â  #palette {
Â  Â  position: fixed;
Â  Â  top: var(--header-height);
Â  Â  right: 0;
Â  Â  bottom: 0; /* Full height */
Â  Â  width: 280px;
Â  Â  border-left: 1px solid #ccc;
Â  Â  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
Â  Â  overflow-y: auto;
Â  Â  overscroll-behavior: contain;
Â  }
}
@media (max-width: 991px) {

Â  /* ==================================================
Â  Â  Â MOBILE HEADER FIX â€” QUIZ MODE ONLY
Â  Â  Â ================================================== */

Â  body.mode-quiz .header-inner {
Â  Â  flex-wrap: wrap;
Â  }

Â  /* Quiz title on its own line */
Â  body.mode-quiz .header-inner > div:first-child {
Â  Â  width: 100%;
Â  Â  justify-content: flex-start;
Â  Â Â 
Â  }

Â  body.mode-quiz #headerTitle {
Â  Â  max-width: 100%;
Â  Â  white-space: nowrap;
Â  Â  overflow: hidden;
Â  Â  text-overflow: ellipsis;
Â  Â  font-size: 16px;
Â  }

Â  /* Buttons row (View / Timer / Submit) */
Â  body.mode-quiz .header-inner > div:last-child {
Â  Â  width: 100%;
Â  Â  display: flex;
Â  Â  justify-content: flex-end;Â  Â /* push group to right */
Â  Â  gap: 8px;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  /* SAME spacing as now */
Â  Â  padding-left: 30%;Â  Â  Â  Â  Â  Â /*  starts from middle */
Â  }

}

@media (max-width: 991px) {

Â  /* Space below sticky header */
Â  #nameContainer {
Â  Â  margin-top: 12px;
Â  Â  margin-bottom: 8px;
Â  Â  padding: 0 12px;
Â  }

Â  #sectionNav {
Â  Â  margin-top: 0;Â  Â  Â  Â  Â /* Remove top margin so it touches the header */
Â  Â  margin-bottom: 10px;
Â  Â  padding: 10px 12px;
Â  Â  width: 100%;Â  Â  Â  Â  Â  Â /* Full width on mobile */
Â  Â  margin-right: 0;Â  Â  Â  Â /* Remove the desktop palette gap */
Â  Â Â 
Â  Â  /* Ensure stickiness is active on mobile too */
Â  Â  position: sticky;
Â  Â  top: var(--header-height);Â 
Â  Â  z-index: 99;
Â  Â  background: #fff;
Â  Â  border-bottom: 1px solid #ddd;
Â  }

}

@media (min-width: 992px) {
Â  /* ... existing code ... */

Â  /* Make header buttons smaller */
Â  .btn-sm {
Â  Â  padding: 6px 12px !important; /* Smaller padding */
Â  Â  font-size: 13px !important;Â  Â  /* Smaller text */
Â  Â  min-width: auto !important;Â  Â  /* Remove the 120px minimum width */
Â  }
}

/* =========================================
Â  Â 9. ANALYSIS DASHBOARD (From gem test.html)
Â  Â ========================================= */
.analysis-container { max-width: 900px; margin: auto; display: flex; flex-direction: column; gap: 14px; padding: 10px 0; }
.card-dashboard { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 14px rgba(0,0,0,.08); border: 1px solid #edf2f7; }

.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px; color: #444; }
.info-grid div b { color: #111; }

.score-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; text-align: center; }
.score-item { background: #f8fbff; border-radius: 10px; padding: 14px; border: 1px solid #e1ecff; }
.score-item h4 { margin: 0; font-size: 13px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; }
.score-item p { margin: 6px 0 0; font-size: 20px; font-weight: 800; color: #222; }

.attempt-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; text-align: center; }
.attempt-box { padding: 12px; border-radius: 10px; font-weight: 700; font-size: 13px; border: 1px solid transparent; }
.attempt-box span { display: block; font-size: 20px; margin-top: 4px; font-weight: 800; }

.at-correct { background: #e6f7ee; color: var(--success); border-color: #c3e6cb; }
.at-wrong { background: #fdeaea; color: var(--danger); border-color: #f5c6cb; }
.at-unattempted { background: #fff8e1; color: #b77c00; border-color: #ffeeba; }
.at-total { background: #e7f0ff; color: var(--accent); border-color: #b6d4fe; }

.action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 10px; }
.btn-dash { padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; transition: 0.2s; text-align: center; border: 2px solid transparent; }
.btn-solid { background: var(--accent); color: #fff; }
.btn-solid:hover { background: var(--accent-dark); }
.btn-outline { background: #fff; color: var(--accent); border-color: var(--accent); }
.btn-outline:hover { background: #f0f6ff; }

/* Comparison Bars */
.bar-section { margin-top: 10px; }
.bar-row { margin-bottom: 16px; }
.bar-label { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: #555; }
.bar-track { height: 10px; background: #e9ecef; border-radius: 99px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 99px; transition: width 1s ease-out; }
.fill-you { background: var(--accent); }
.fill-topper { background: var(--success); }
.bar-values { display: flex; justify-content: space-between; font-size: 12px; margin-top: 4px; color: #777; font-weight: 600; }

/* Topper Table */
.topper-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
.topper-table th { background: #f1f5f9; color: #444; font-weight: 700; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
.topper-table td { padding: 10px; border-bottom: 1px solid #eee; color: #333; }
.section-title { font-size: 16px; font-weight: 700; margin: 0 0 14px; color: #222; padding-bottom: 8px; border-bottom: 1px solid #eee; }
/* Change this to force a solid background and continuous flow */
#results {
Â  Â  position: relative !important; /* Forces it to stay in the page flow, not float */
Â  Â  background: #ffffff !important; /* Solid white background - no transparency */
Â  Â  width: 100%;
Â  Â  min-height: 100vh; /* Ensures white background covers the full screen height */
Â  Â  margin: 0 auto;
Â  Â  padding-bottom: 80px; /* Space for the bottom navigation */
Â  Â  display: none; /* Controlled by JavaScript */
Â  Â  z-index: 100; /* Keeps it above the background watermark */
}

/* Ensure the inner container doesn't add extra floating gaps */
.analysis-container {
Â  Â  background: #ffffff; /* Matches the parent for a seamless look */
Â  Â  max-width: 900px;
Â  Â  margin: auto;
Â  Â  padding: 20px 10px;
}
Â  /* Language Dropdown Styling */
#langSelect {
Â  background-color: #fff;
Â  border: 1px solid var(--accent);
Â  color: var(--accent);
Â  border-radius: 4px;
Â  font-weight: 600;
Â  cursor: pointer;
Â  outline: none;
}

/* Ensure header items don't overlap on small screens */
@media (max-width: 600px) {
Â  .header-inner {
Â  Â  padding: 0 8px;
Â  }
Â  #langSelect {
Â  Â  font-size: 11px;
Â  Â  padding: 2px;
Â  }
Â  .timer-text {
Â  Â  font-size: 14px;
Â  Â  padding: 2px 6px;
Â  }
}

Â  @media (max-width: 480px) {
Â  .welcome-footer {
Â  Â  flex-wrap: wrap;
Â  Â  gap: 10px;
Â  }

Â  .welcome-footer button,
Â  .welcome-footer select {
Â  Â  width: 100%;
Â  }
Â  }
Â  @media (min-width: 992px) {
Â  body {
Â  Â  overflow-y: scroll;
Â  }
}

/* =========================================
Â  Â 10. UTILITIES & MODALS
Â  Â ========================================= */
.hidden { display: none !important; }

/* Modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
.modal-content { background: #fff; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center; }
.modal h3 { margin-top: 0; color: var(--accent); }
.modal .actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }

/* Watermark */
.ssc-watermark { position: fixed; inset: 0; z-index: 1; pointer-events: none; overflow: hidden; }
.ssc-wm { position: absolute; font-size: 26px; font-weight: 700; color: rgba(0,0,0,0.045); transform: rotate(-30deg); white-space: nowrap; }

/* MathJax */
mjx-container { font-family: inherit !important; font-size: 1em; overflow-x: auto; }


/* Loader Overlay */
#loadingOverlay {
Â  position: fixed; inset:0; background:#fff; z-index:9999;
Â  display:flex; justify-content:center; align-items:center; flex-direction:column;
}
.spinner {
Â  width: 40px; height: 40px; border: 4px solid #f3f3f3;
Â  border-top: 4px solid #0b5ed7; border-radius: 50%;
Â  animation: spin 1s linear infinite; margin-bottom:15px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

Â  /* =========================================
Â  Â NEW: SECTION NAVIGATION & TABLE STYLES
Â  Â ========================================= */
.section-nav {
Â  display: flex;Â 
Â  gap: 8px;Â 
Â  padding: 10px 16px;Â 
Â  background: #fff;
Â  border-bottom: 2px solid #eee;Â 
Â  overflow-x: auto;Â 
Â  white-space: nowrap;
}

/* Part Buttons (Reasoning, Math, etc.) */
.sec-btn {
Â  padding: 8px 18px;Â 
Â  background: #0000ff; /* Blue for Inactive */
Â  color: #fff;Â 
Â  border: none;
Â  border-radius: 4px;Â 
Â  font-weight: 700;Â 
Â  cursor: pointer;Â 
Â  font-size: 13px;
Â  text-transform: uppercase;
}

/* Active Section Button - Becomes Green */
.sec-btn.active {Â 
Â  background: #008000 !important;Â 
}

/* Sectional Analysis Table */
.analysis-table {
Â  width: 100%;Â 
Â  border-collapse: collapse;Â 
Â  margin-bottom: 20px;Â 
Â  font-size: 13px;
}
.analysis-table th {Â 
Â  background: #f1f5f9;Â 
Â  padding: 10px;Â 
Â  border: 1px solid #ddd;Â 
}
.analysis-table td {Â 
Â  padding: 10px;Â 
Â  border: 1px solid #ddd;Â 
Â  text-align: center;Â 
Â  font-weight: 600;Â 
}

</style>

<script>
Â  window.MathJax = {
Â  Â  tex: {
Â  Â  Â  /* ONLY these are allowed */
Â  Â  Â  inlineMath: [['\\(', '\\)']],Â  Â  Â // optional inline math
Â  Â  Â  displayMath: [['$$', '$$'], ['\\[', '\\]']]Â  // block math ONLY
Â  Â  },
Â  Â  options: {
Â  Â  Â  skipHtmlTags: ['script', 'style', 'textarea', 'pre']
Â  Â  }
Â  };
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

</head>
<body>

<div id="loadingOverlay">
Â  <div class="spinner"></div>
Â  <h3 id="loadingText">Loading Quiz Data...</h3>
</div>

<div class="welcome-screen" id="welcomeScreen">
Â  <div class="welcome-container">

Â  Â  <div style="text-align: center;">
Â  Â  Â  <a class="channel-link-top" href="https://t.me/SSC_COMPILATIONS_2025" target="_blank">ğŸ“¢ Join Telegram Channel</a>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  <div class="welcome-header">
Â  Â  Â  <h1 id="disp_quizTitle">Loading...</h1> <p>Quiz ID: <span id="disp_quizId">...</span></p>
Â  Â  </div>

Â  Â  <div class="test-details">
Â  Â  Â  <div class="detail-item">
Â  Â  Â  Â  <div class="detail-label">Total Questions</div>
Â  Â  Â  Â  <div class="detail-value" id="disp_totalQ">-</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="detail-item">
Â  Â  Â  Â  <div class="detail-label">Correct Marks</div>
Â  Â  Â  Â  <div class="detail-value" id="disp_correct">-</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="detail-item">
Â  Â  Â  Â  <div class="detail-label">Negative Marks</div>
Â  Â  Â  Â  <div class="detail-value" id="disp_negative">-</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="detail-item">
Â  Â  Â  Â  <div class="detail-label">Total Time</div>
Â  Â  Â  Â  <div class="detail-value"><span id="disp_time">-</span> Minutes</div>
Â  Â  Â  </div>
Â  Â  </div>
<div id="welcomeSectionTableContainer" style="margin-bottom: 24px;">
Â  <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 700; border-left: 4px solid var(--accent); padding-left: 10px; color: #333;">Test Summary</h3>
Â  <div style="overflow-x:auto;">
Â  Â  <table style="width:100%; border-collapse: collapse; background: #fff; border: 1px solid #ddd; font-size: 13px;">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr style="background: #f1f5f9; color: #444;">
Â  Â  Â  Â  Â  <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Section Name</th>
Â  Â  Â  Â  Â  <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Questions</th>
Â  Â  Â  Â  Â  <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Marks</th>
Â  Â  Â  Â  Â  <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Negative</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="welcomeSectionTableBody"></tbody>
Â  Â  Â  <tfoot id="welcomeSectionTableFoot" style="background: #f8fbff; font-weight: 800; color: #222;"></tfoot>
Â  Â  </table>
Â  </div>
</div>
Â  Â Â 
Â  Â  <div class="welcome-instructions">
Â  Â  Â  <h3>1. Quiz Mode Symbols (During Test)</h3>
Â  Â  Â  <div class="symbol-list">
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box leg-answered">1</div> Answered</div>
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box leg-marked-ans">2</div> Answered & Marked for Review</div>
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box leg-marked">3</div> Marked for Review (Unanswered)</div>
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box leg-current">4</div> Current Question</div>
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box leg-notvisited">5</div> Not Visited</div>
Â  Â  Â  </div>

Â  Â  Â  <h3>2. Solution Mode Symbols (Analysis)</h3>
Â  Â  Â  <div class="symbol-list">
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box" style="background: #198754;">âœ”</div> Correct Answer</div>
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box" style="background: #dc3545;">âœ–</div> Wrong Answer</div>
Â  Â  Â  Â  <div class="symbol-item"><div class="leg-box" style="background: #bdbdbd; color:#000;">0</div> Skipped</div>
Â  Â  Â  </div>

Â  Â  Â  <h3>3. General Instructions / à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶</h3>
Â  Â  Â  <ul>
Â  Â  Â  Â  <li><b>Name Entry:</b> You <u>MUST</u> enter your full name in the box provided inside the quiz to submit.</li>
Â  Â  Â  Â  <li><b>Do not reload the page.</b><br><span>à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥‡à¤œ à¤•à¥‹ à¤°à¥€à¤²à¥‹à¤¡ à¤¨ à¤•à¤°à¥‡à¤‚à¥¤</span></li>
Â  Â  Â  Â  <li><b>Stable internet is required.</b><br><span>à¤¸à¥à¤¥à¤¿à¤° à¤‡à¤‚à¤Ÿà¤°à¤¨à¥‡à¤Ÿ à¤¸à¥à¤¨à¤¿à¤¶à¥à¤šà¤¿à¤¤ à¤•à¤°à¥‡à¤‚à¥¤</span></li>
Â  Â  Â  Â  <li><b>Submit before time ends.</b><br><span>à¤¸à¤®à¤¯ à¤¸à¤®à¤¾à¤ªà¥à¤¤ à¤¹à¥‹à¤¨à¥‡ à¤¸à¥‡ à¤ªà¤¹à¤²à¥‡ à¤œà¤®à¤¾ à¤•à¤°à¥‡à¤‚à¥¤</span></li>
Â  Â  Â  </ul>

Â  Â  Â  <div style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; background: #fff;">
Â  Â  Â  Â  Â <label style="display: flex; align-items: flex-start; gap: 10px; font-size: 13px; cursor: pointer;">
Â  Â  Â  Â  Â  Â <input type="checkbox" id="instrConfirm" style="margin-top: 3px;">
Â  Â  Â  Â  Â  Â <span>I have read all the instructions carefully and have understood them. I agree not to cheat or use unfair means in this examination.</span>
Â  Â  Â  Â  Â </label>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="welcome-footer">
Â  Â  <button class="back-btn" onclick="window.location.href='./'">Back</button>
Â  Â Â 
Â  Â  <div style="display: flex; align-items: center; gap: 10px;">
Â  Â  Â  <span style="font-size: 13px; font-weight: 700;">Select Language:</span>
Â  Â  Â  <select id="welcomeLangSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
Â  Â  Â  Â  <option value="">Select Language</option>
Â  Â  Â  Â  <option value="en">English</option>
Â  Â  Â  Â  <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
Â  Â  Â  Â  <option value="bilingual">Bilingual</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <button id="welcomeStartBtn" class="start-btn">Start Test</button>
Â  </div>
</div>
Â  Â  Â  Â 
<div id="ssc-watermark" class="ssc-watermark">
Â  <div class="ssc-wm" style="top:10%; left:5%;">@SSC_COMPILATIONS_2025</div>
Â  <div class="ssc-wm" style="top:30%; left:60%;">@SSC_COMPILATIONS_2025</div>
Â  <div class="ssc-wm" style="top:55%; left:25%;">@SSC_COMPILATIONS_2025</div>
Â  <div class="ssc-wm" style="top:75%; left:65%;">@SSC_COMPILATIONS_2025</div>
Â  <div class="ssc-wm" style="top:90%; left:10%;">@SSC_COMPILATIONS_2025</div>
</div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
Â  apiKey: "AIzaSyBJqYcRm7Uvii5yDMWt4iL3dDiMEHPNtU0",
Â  authDomain: "mmh-cgl-full-mock-data.firebaseapp.com",
Â  databaseURL: "https://mmh-cgl-full-mock-data-default-rtdb.firebaseio.com",
Â  projectId: "mmh-cgl-full-mock-data",
Â  storageBucket: "mmh-cgl-full-mock-data.firebasestorage.app",
Â  messagingSenderId: "641355846419",
Â  appId: "1:641355846419:web:dde8ef021949c53d2b40e6"
};
Â firebase.initializeApp(firebaseConfig);
Â  const db = firebase.database();
</script>


<header id="mainHeader" style="display:none;">
Â  <div class="header-inner">

Â  Â  <div style="display:flex; align-items:center; gap:10px;">
Â  Â  Â  <button id="backToAnalysisBtn" class="btn-ghost" style="display:none;">â¬… Analysis</button>
Â  Â  Â  <h1 id="headerTitle">Loading...</h1>
<div id="headerUsername" class="header-username-box">User</div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div style="display:flex; align-items:center; gap:10px;">
Â  Â  Â  <select id="langSelect" class="btn-ghost" style="padding: 4px; font-size: 13px;">
Â  Â  Â  Â  <option value="en">English</option>
Â  Â  Â  Â  <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
Â  Â  Â  Â  <option value="bilingual">EN+HI</option>
Â  Â  Â  </select>
Â  Â  <div id="topActions" class="top-actions">
Â  Â  <button id="prevBtn" class="btn-prev btn-ghost btn-sm">Previous</button>
Â  Â  <button id="clearBtn" class="btn-clear btn-ghost btn-sm">Clear</button>
Â  Â  <button id="markBtn" class="btn-mark btn-ghost btn-sm">Mark for Review</button>
Â  Â  <button id="nextBtn" class="btn-next btn btn-sm">Save & Next</button>
</div>
Â  Â 
Â  Â  Â  <div class="timer-text" id="timer">00:00</div>
Â  Â  Â  <button id="submitBtn" class="btn">Submit</button>
Â  Â  Â  <button id="paletteBtn" class="btn-ghost">View</button>
Â  Â  </div>
Â  </div>
</header>



<div id="sectionNav" class="section-nav" style="display:none;"></div>
<div class="container">

Â  <div class="quiz-main-area" id="quizMainArea" style="display:none;">

Â  Â  <div id="quizCard" class="card">
Â  Â  Â  <div class="qbar">
Â  Â  Â  Â  <div class="qmeta">Question <span id="qindex">1</span> / <span id="qtotal">-</span></div>
Â  Â 
Â  Â  Â  Â  <div class="marking" id="marking"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="qtext" id="qtext"></div>
Â  Â  Â  <div id="questionImage" style="margin:12px 0;"></div>
Â  Â  Â  <div class="options" id="options"></div>

Â  Â  Â  <div id="explanation" class="explanation"></div>
Â  Â  </div>

Â  Â  <div id="palette" aria-hidden="true">

Â  Â  Â  <div id="palette-legend">
Â  Â  Â  Â  <div><span class="lg-box notvisited"></span> Not Visited</div>
Â  Â  Â  Â  <div><span class="lg-box answered"></span> Answered</div>
Â  Â  Â  Â  <div><span class="lg-box marked"></span> Marked</div>
Â  Â  Â  Â  <div><span class="lg-box marked-answered">â˜…</span> Ans & Marked</div>
Â  Â  Â  </div>

Â  Â  Â  <div id="palette-summary" style="margin-bottom:10px; font-weight:700; font-size:13px; text-align:center;"></div>

Â  Â  Â  <div id="palette-grid" class="palette-grid"></div>

Â  Â  </div>

Â  </div> <div id="results" class="results" style="display:none"></div>
Â  <div id="previousAttempts" class="results" style="display:none"></div>
Â  <div id="attemptReplay" class="results" style="display:none"></div>

</div>
<div class="fbar" id="floatBar" style="display:none;">
Â  <button id="prevBtn">Previous</button> <button id="clearBtn">Clear</button>
Â  <button id="markBtn">Mark for Review</button>
Â  <button id="nextBtn">Save & Next</button> </div>


<div id="submitModal" class="modal">
Â  <div class="modal-content">
Â  Â  <h3>Submit Quiz?</h3>
Â  Â  <p id="submitMsg">Are you sure you want to submit?</p>
Â  Â  <div class="actions">
Â  Â  Â  <button id="cancelSubmit" class="btn-ghost">Cancel</button>
Â  Â  Â  <button id="confirmSubmit" class="btn">Submit</button>
Â  Â  </div>
Â  </div>
</div>

<script>

// ğŸ”§ DYNAMIC CONFIGURATION
let QUIZ_TITLE = "";
let QUIZ_ID = "";
let QUIZ_STATE_KEY = "";
let QUIZ_RESULT_KEY = "";
let CORRECT_SCORE = 2; // Default, will update
let NEGATIVE_SCORE = 0.5; // Default, will update
let TOTAL_TIME_SECONDS = 0;

let USER_EMAIL_KEY = "";Â  Â  // Used for Firebase paths (dots replaced with commas)
let USER_DISPLAY_NAME = ""; // Used for display and 'name' field in DB


// â± VARIABLES
let current = 0;
let answers = {};
let marked = {};
let seconds = 0;Â  Â  Â  Â  Â  Â  Â  // Changed from placeholder
let timerInterval = null;
let isQuiz = true;
let LAST_RESULT_HTML = "";
let currentLang = "en";


// ğŸ—„ DATA ARRAYS
let QUESTIONS = [];
let SECTIONS = {};Â  Â  Â  Â  Â  Â // New: Grouped questions
let SECTION_NAMES = [];Â  Â  Â  // New: Names for Part-A, Part-B
let currentSectionIdx = 0;Â  Â // New: Active section tracking

let sectionTime = {};Â  Â  Â  Â  // <-- ADD THIS LINE

// ===============================
// ğŸ› ï¸ HELPER FUNCTIONS
// ===============================

// Short helper for getting elements
const el = id => document.getElementById(id);

// Format seconds into MM:SS
function fmt(s){
Â  s = Math.max(0, s);
Â  const m = Math.floor(s/60);
Â  const sec = s%60;
Â  return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

// Save current progress to LocalStorage
function saveQuizState(){
Â  // Don't save state if we are just viewing solutions
Â  if(!isQuiz) return;

Â  const state = {
Â  Â  current,
Â  Â  answers,
Â  Â  marked,
Â  Â  currentLang,
Â  Â  seconds,
Â  Â  currentSectionIdx // NEW: Save the active section index (PART-1, PART-2, etc.)
Â  };
Â  localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(state));
}
// ===============================
// â±ï¸ TIMER LOGIC
// ===============================
function startTimer() {
Â  if (timerInterval) clearInterval(timerInterval);

Â  // Always show valid time
Â  seconds = Math.max(0, seconds);
Â  el("timer").textContent = fmt(seconds);

Â  timerInterval = setInterval(() => {

Â  Â  // â›” STOP exactly at zero
Â  Â  if (seconds <= 0) {
Â  Â  Â  seconds = 0;
Â  Â  Â  el("timer").textContent = "00:00";
Â  Â  Â  clearInterval(timerInterval);

Â  Â  Â  // ğŸ”¥ AUTO SUBMIT
Â  Â  Â  autoSubmitQuiz();
Â  Â  Â  return;
Â  Â  }

Â  Â  // Normal countdown
Â  Â  seconds--;
Â  Â  el("timer").textContent = fmt(seconds);

Â  Â  // NEW: Track time for the active section
Â  Â  const activeSectionName = SECTION_NAMES[currentSectionIdx];
Â  Â  if (!sectionTime[activeSectionName]) sectionTime[activeSectionName] = 0;
Â  Â  sectionTime[activeSectionName]++;Â 

Â  Â  // Save state safely
Â  Â  if (seconds % 5 === 0) saveQuizState();

Â  }, 1000);
}
// NEW: Logic to switch between PART-1, PART-2 etc.
function switchSection(idx) {
Â  currentSectionIdx = idx;
Â  const sName = SECTION_NAMES[idx];
Â Â 
Â  // Update the QUESTIONS global to only show this section's questions
Â  QUESTIONS = SECTIONS[sName];
Â  current = 0; // Restart numbering at 1 for this section

Â  // Update Section Button Colors (Green for Active, Blue for Inactive)
Â  document.querySelectorAll('.sec-btn').forEach((btn, i) => {
Â  Â  btn.classList.toggle('active', i === idx);
Â  });

Â  // Re-build the palette grid for the new section
Â  buildPalette();
Â  renderQuestion(0);
Â  saveQuizState(); // Persist the current section if user reloads
}
// ===============================
// ğŸ“ RENDER QUESTION ENGINE
// ===============================
function renderQuestion(i) {
Â 
Â  // --- ADD THIS SAFETY GUARD AT THE TOP ---
Â  if (!QUESTIONS || QUESTIONS.length === 0 || !QUESTIONS[i]) {
Â  Â  console.warn("renderQuestion skipped: Data not ready yet.");
Â  Â  return;Â 
Â  }

Â  current = i;
Â  const q = QUESTIONS[i];

Â  // 1. Update Header Info - NOW SCOPED TO ACTIVE SECTION
Â  el("qindex").textContent = i + 1;
Â  el("qtotal").textContent = QUESTIONS.length;

Â  // --- LANGUAGE HELPER FUNCTION ---
Â  const getLangText = (obj) => {
Â  Â  if (!obj) return "";
Â  Â  if (typeof obj === "string") return obj;Â 

Â  Â  if (currentLang === "bilingual") {
Â  Â  Â  const enText = obj.en || "";
Â  Â  Â  const hiText = obj.hi || "";
Â  Â  Â  return enText + (enText && hiText ? "<hr style='border:none; border-top:1px dashed #ccc; margin:10px 0;'>" : "") + hiText;
Â  Â  }
Â  Â  return obj[currentLang] || obj["en"] || "";
Â  };

Â  // 2. Render Question Text & Math
Â  const qTextEl = el("qtext");
Â  qTextEl.innerHTML = getLangText(q.question);
Â  normalizeMathForQuiz(qTextEl);

Â  // ğŸ–¼ï¸ QUESTION IMAGE RENDER (40% size)
Â  const imgBox = document.getElementById("questionImage");
Â  imgBox.innerHTML = "";

Â  if (q.question_image && q.question_image.trim() !== "") {
Â  Â  const img = document.createElement("img");
Â  Â  img.src = q.question_image;
Â  Â  img.alt = "Question Image";
Â  Â  img.style.width = "40%";Â 
Â  Â  img.style.height = "auto";
Â  Â  img.style.display = "block";
Â  Â  img.style.margin = "10px auto";
Â  Â  img.style.border = "1px solid #ddd";
Â  Â  img.style.borderRadius = "6px";
Â  Â  img.loading = "lazy";

Â  Â  img.onerror = () => {
Â  Â  Â  imgBox.innerHTML = "<div style='color:red;font-size:13px'>âš  Image failed to load</div>";
Â  Â  };

Â  Â  imgBox.appendChild(img);
Â  }

Â  // 3. Update Marks
Â  el("marking").innerHTML = `Marking: <span style="color:var(--success)">+${Number(q.correct_score ?? 1)}</span> / <span style="color:var(--danger)">-${Number(q.negative_score ?? 0)}</span>`;

Â  // 4. Render Options (Updated to include Option Images)
Â  const optsContainer = el("options");
Â  optsContainer.innerHTML = "";

Â  const optionKeys = ["option_1", "option_2", "option_3", "option_4", "option_5"];

Â  optionKeys.forEach((key, idx) => {
Â  Â  if (!q[key]) return;Â 

Â  Â  const optionIndex = idx + 1;Â 
Â  Â  const isSelected = answers[q.id] === String(optionIndex); // Use q.id strictly
Â  Â  const isCorrectAns = String(q.answer) === String(optionIndex);

Â  Â  const div = document.createElement("div");
Â  Â  div.className = "opt";

Â  Â  if (isQuiz) {
Â  Â  Â  if (isSelected) div.classList.add("selected");
Â  Â  Â 
Â  Â  } else {
Â  Â  Â  div.style.cursor = "default";
Â  Â  Â  if (isCorrectAns) {
Â  Â  Â  Â  div.classList.add("correct");
Â  Â  Â  Â Â 
Â  Â  Â  }
Â  Â  Â  if (isSelected && !isCorrectAns) {
Â  Â  Â  Â  div.classList.add("wrong");
Â  Â  Â  Â Â 
Â  Â  Â  }
Â  Â  }

Â  Â  // ğŸ–¼ï¸ OPTION IMAGE RENDER (40% size)
Â  Â  const optImgKey = `option_image_${optionIndex}`;
Â  Â  let optImgHtml = "";
Â  Â  if (q[optImgKey] && q[optImgKey].trim() !== "") {
Â  Â  Â  optImgHtml = `<div style="margin-top:8px;"><img src="${q[optImgKey]}" style="width:40%; height:auto; border-radius:4px; border:1px solid #eee;"></div>`;
Â  Â  }

Â  Â  div.innerHTML = `
Â  Â  Â  <div class="custom-radio"></div>
Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  <div class="opt-text">${getLangText(q[key])}</div>
Â  Â  Â  Â  ${optImgHtml}
Â  Â  Â  </div>
Â  Â  `;
const radio = div.querySelector(".custom-radio");

if (isQuiz) {
Â  radio.addEventListener("click", (e) => {
Â  Â  e.stopPropagation();Â  Â // ğŸ”¥ CRITICAL
Â  Â  selectOption(q, optionIndex, div);
Â  });
}

Â  Â  optsContainer.appendChild(div);
Â  Â  normalizeMathForQuiz(div.querySelector(".opt-text"));
Â  });

Â  // 5. Render Explanation (Only in Solution Mode)
Â  const expBox = el("explanation");
Â  if (!isQuiz) {
Â  Â  const qid = q.id;
Â  Â  const userAns = answers[qid];
Â  Â  const isCorrect = userAns && String(userAns) === String(q.answer);

Â  Â  let statusText = "";
Â  Â  if (!userAns) {
Â  Â  Â  statusText = `<span style="color:#9e9e9e">Skipped (0)</span>`;
Â  Â  } else if (isCorrect) {
Â  Â  Â  statusText = `<span style="color:var(--success)">Correct (+${q.correct_score ?? 3})</span>`;
Â  Â  } else {
Â  Â  Â  statusText = `<span style="color:var(--danger)">Wrong (-${q.negative_score ?? 1})</span>`;
Â  Â  }

Â  Â  let solImgHtml = "";
Â  Â  if (q.solution_image && q.solution_image.trim() !== "") {
Â  Â  Â  solImgHtml = `<div style="margin-top:15px; text-align:center;"><img src="${q.solution_image}" style="width:40%; height:auto; border-radius:6px; border:1px solid #ddd;"></div>`;
Â  Â  }

Â  Â  expBox.style.display = "block";
Â  Â  expBox.innerHTML = `<div style="margin-bottom:8px; font-weight:700;">Status: ${statusText}</div>` +
Â  Â  Â  (q.solution_text ? `<hr style="border:0; border-top:1px solid #ddd; margin:8px 0;"><strong>ğŸ’¡ Explanation:</strong><br>${getLangText(q.solution_text)}` : "") +
Â  Â  Â  solImgHtml;
Â  Â  normalizeMathForQuiz(expBox);
Â  } else {
Â  Â  expBox.style.display = "none";
Â  }

Â  // 6. Update MathJax
Â  renderMath();

Â  // 7. Update Palette & Buttons
Â  if (typeof highlightPalette === "function") highlightPalette();
Â  updateNavButtons();

Â  // Handle language synchronization
Â  const langSelect = document.getElementById("langSelect");
Â  if (langSelect) {
Â  Â  langSelect.onchange = (e) => {
Â  Â  Â  currentLang = e.target.value;
Â  Â  Â  saveQuizState();
Â  Â  Â  renderQuestion(current);
Â  Â  };
Â  }
}


// ===============================
// ğŸ–±ï¸ OPTION SELECTION
// ===============================
function selectOption(q, val, divEl){
Â  // Prevent changing answers in Solution Mode
Â  if(!isQuiz) return;

Â  const qid = q.id ?? current;

Â  // Toggle Logic: If clicking same option, unselect it?
Â  // Testbook usually allows changing, not unselecting easily,
Â  // but let's stick to: Click new -> Select new.

Â  answers[qid] = String(val);
Â  saveQuizState();

Â  // Re-render to update visuals
Â  renderQuestion(current);
}

// ===============================
// ğŸ”„ MATHJAX UTILS
// ===============================
function renderMath(){
Â  if (window.MathJax && MathJax.typesetPromise) {
Â  Â  MathJax.typesetPromise();
Â  }
}

function normalizeMathForQuiz(container) {
Â  if (!container) return;
Â  // Convert $$...$$ block math to \(...\) inline math for better mobile flow
Â  container.innerHTML = container.innerHTML
Â  Â  .replace(/(\S)\s*\$\$(.+?)\$\*\s*(\S)/g, '$1 \\($2\\) $3')
Â  Â  .replace(/\$\$(.+?)\$\$/g, '\\($1\\)');
}

// Update Prev/Next Button States
function updateNavButtons() {
Â  const prev = el("prevBtn");
Â  const next = el("nextBtn");

Â  if(prev) prev.disabled = current === 0;
Â  if(next) next.disabled = current === QUESTIONS.length - 1;
}
// ===============================
// ğŸš€ SUBMIT & ANALYSIS ENGINE
// ===============================
function submitQuiz(isAuto = false) {
Â Â 
Â  // 2. ğŸ›‘ Stop Timer & Hide Quiz UI
Â  if (timerInterval) clearInterval(timerInterval);
Â  const timeTakenSeconds = TOTAL_TIME_SECONDS - seconds;

Â  document.getElementById("mainHeader").style.display = "none";
Â 
Â  if (el("sectionNav")) el("sectionNav").style.display = "none";
Â  document.getElementById("floatBar").style.display = "none";
Â  const quizArea = document.getElementById("quizMainArea");
Â  if(quizArea) quizArea.style.display = "none";

Â  const resBox = document.getElementById("results");
Â  resBox.style.display = "block";
Â  resBox.innerHTML = `<div class="card-dashboard" style="text-align:center; padding:50px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color:var(--accent);">Generating analysis...</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Please wait while we calculate your sectional ranks and toppers list.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;


Â  // 3. ğŸ§® Calculate Global & Sectional Scores
Â  let totalCorrect = 0, totalWrong = 0, totalMarks = 0, maxTotalMarks = 0;
Â  let totalQuestionsCount = 0; // Added for precise math
Â  const sectionalDataForFirebase = {};
Â  let sectionalBarsHTML = "";

Â  SECTION_NAMES.forEach(sName => {
Â  Â  let sCor = 0, sWr = 0, sScore = 0, sMax = 0;
Â  Â  totalQuestionsCount += SECTIONS[sName].length;
Â  Â Â 
Â  Â  SECTIONS[sName].forEach(q => {
Â  Â  Â  sMax += Number(q.correct_score ?? 2);
Â  Â  Â  const ans = answers[q.id];
Â  Â  Â  if (ans == q.answer) {
Â  Â  Â  Â  sCor++;
Â  Â  Â  Â  sScore += Number(q.correct_score ?? 2);
Â  Â  Â  } else if (ans) {
Â  Â  Â  Â  sWr++;
Â  Â  Â  Â  sScore -= Number(q.negative_score ?? 0.5);
Â  Â  Â  }
Â  Â  });

Â  Â  // Store per section - UPDATED: sectionTime[sName] tracks the real time spent
Â  Â  sectionalDataForFirebase[sName] = {
Â  Â  Â  score: sScore,
Â  Â  Â  total: sMax,
Â  Â  Â  correct: sCor,
Â  Â  Â  wrong: sWr,
Â  Â  Â  unattempted: SECTIONS[sName].length - (sCor + sWr),
Â  Â  Â  timeTaken: sectionTime[sName] || 0Â 
Â  Â  };

Â  Â  totalCorrect += sCor;
Â  Â  totalWrong += sWr;
Â  Â  totalMarks += sScore;
Â  Â  maxTotalMarks += sMax;
Â  });

Â  const attempted = totalCorrect + totalWrong;
Â  const accuracy = attempted ? ((totalCorrect / attempted) * 100).toFixed(2) : "0.00";
Â  const timeFormatted = fmt(timeTakenSeconds);

Â  // 4. ğŸ“¦ Prepare Data Payload
Â  const firebasePayload = {
Â  Â  name: USER_DISPLAY_NAME, // Unique username from Auth
Â  Â  score: totalMarks,
Â  Â  total: maxTotalMarks,
Â  Â  correct: totalCorrect,
Â  Â  wrong: totalWrong,
Â  Â  timeTaken: timeTakenSeconds,
Â  Â  quizId: QUIZ_ID,
Â  Â  emailKey: USER_EMAIL_KEY, // Replaces deviceId
Â  Â  submittedAt: Date.now(),
Â  Â  sections: sectionalDataForFirebaseÂ 
Â  };

Â  // 5. â˜ï¸ Firebase Operations
Â  saveResultFirebase(firebasePayload).finally(() => {
Â  Â  saveAttemptHistory(firebasePayload);

Â  Â  Promise.all([
Â  Â  Â  getRankAndPercentile(QUIZ_ID, totalMarks, timeTakenSeconds, firebasePayload.submittedAt),
Â  Â  Â  getToppersList(QUIZ_ID)
Â  Â  ]).then(([rankData, toppersList]) => {

Â  Â  Â  const topperStats = getTopperStatsForComparison(toppersList, attempted);

Â  Â  Â  // 6. ğŸ“Š Generate Sectional Summary Table
Â  Â  Â  let sectionalTableHtml = `
Â  Â  Â  <div class="card-dashboard">
Â  Â  Â  Â  <h3 class="section-title">ğŸ“Š Sectional Summary</h3>
Â  Â  Â  Â  <div style="overflow-x:auto">
Â  Â  Â  Â  Â  <table class="analysis-table">
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Section</th><th>Marks</th><th>Correct</th><th>Wrong</th><th>Left</th><th>Time Spent</th>
Â  Â  Â  Â  Â  Â  </tr>`;


SECTION_NAMES.forEach(name => {
Â  const d = sectionalDataForFirebase[name];
Â  const secId = name.replace(/\s+/g, '');Â 

Â  sectionalTableHtml += `
Â  Â  <tr>
Â  Â  Â  <td><b>${name}</b></td>
Â  Â  Â  <td>${d.score}</td>
Â  Â  Â  <td>${d.correct}</td>
Â  Â  Â  <td>${d.wrong}</td>
Â  Â  Â  <td>${d.unattempted}</td>
Â  Â  Â  <td>${fmt(d.timeTaken)}</td>
Â  Â  Â Â 
Â  Â  </tr>`;
Â Â 

Â  const secAttempted = d.correct + d.wrong;

const topperSecRaw = topperStats.sections?.[name] || {};
const topperSec = {
Â  score: topperSecRaw.score || 0,
Â  correct: topperSecRaw.correct || 0,
Â  wrong: topperSecRaw.wrong || 0,
Â  timeTaken: topperSecRaw.timeTaken || 0
};

const topperAttempted = topperSec.correct + topperSec.wrong;

const accuracy = secAttempted
Â  ? ((d.correct / secAttempted) * 100).toFixed(2)
Â  : "0.00";

const topperAccuracy = topperAttempted
Â  ? ((topperSec.correct / topperAttempted) * 100).toFixed(2)
Â  : "0.00";

sectionalBarsHTML += `
Â  <h4 class="section-title" style="margin-top:25px; border-left:4px solid var(--accent); padding-left:10px;">
Â  Â  Part: ${name}
Â  </h4>

Â  ${renderComparisonBar("Score", d.score, d.total, topperSec.score, d.total)}
Â  ${renderComparisonBar("Accuracy", accuracy, 100, topperAccuracy, 100, "%")}
Â  Â  ${renderComparisonBar(
Â  "Correct",
Â  d.correct,
Â  SECTIONS[name].length,
Â  topperSec.correct,
Â  SECTIONS[name].length
)}
${renderComparisonBar(
Â  "Wrong",
Â  d.wrong,
Â  SECTIONS[name].length,
Â  topperSec.wrong,
Â  SECTIONS[name].length,
Â  "",
Â  true
)}

Â  ${renderComparisonBar(
Â  Â  "Time Taken",
Â  Â  d.timeTaken,
Â  Â  TOTAL_TIME_SECONDS,
Â  Â  topperSec.timeTaken,
Â  Â  TOTAL_TIME_SECONDS
Â  )}
`;
Â Â 
});
sectionalTableHtml += `</table></div></div>`;

Â  Â  Â  // 7. ğŸ¨ Generate Dashboard HTML
Â  Â  Â  let dashboardHTML = `
Â  Â  Â  <div class="analysis-container">
Â  Â  Â  Â  <div style="margin-bottom: 10px;">
Â  Â  Â  Â  Â  <button class="btn-dash btn-outline" style="width: 100%; background: #ffffff; color: #333; border: 2px solid #333; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="window.location.href='./'">
Â  Â  Â  Â  Â  Â  <span style="font-size: 18px;">â¬…</span> GO TO ALL TESTS
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard">
Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  <div><b>Name:</b> ${firebasePayload.name}</div>
Â  Â  Â  Â  Â  Â  <div><b>Quiz ID:</b> ${QUIZ_ID}</div>
Â  Â  Â  Â  Â  Â  <div><b>Quiz Name:</b> ${QUIZ_TITLE}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard">
Â  Â  Â  Â  Â  Â <div class="action-grid">
Â  Â  Â  Â  Â  Â  Â  <button class="btn-dash btn-solid" onclick="reattemptQuiz()">ğŸ”„ Reattempt</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn-dash btn-outline" onclick="enterSolutionMode()">ğŸ“Š Detailed Solution</button>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â <div class="action-grid">
Â  Â  Â  Â  Â  Â  Â  <button class="btn-dash btn-outline" onclick="restoreLatestResult()">â¬… Back to Latest Result</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn-dash btn-outline" onclick="loadPreviousAttempts(QUIZ_ID)">ğŸ“ Previous Results</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard score-summary">
Â  Â  Â  Â  Â  <div class="score-item"><h4>ğŸ† Rank</h4><p>${rankData.rank} / ${rankData.total}</p></div>
Â  Â  Â  Â  Â  <div class="score-item"><h4>ğŸ“Š Percentile</h4><p>${rankData.percentile}%</p></div>
Â  Â  Â  Â  Â  <div class="score-item"><h4>ğŸ§® Score</h4><p>${totalMarks} / ${maxTotalMarks}</p></div>
Â  Â  Â  Â  Â  <div class="score-item"><h4>â± Time</h4><p>${timeFormatted}</p></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard attempt-summary">
Â  Â  Â  Â  Â  Â <div class="attempt-box at-correct">âœ… Correct<span>${totalCorrect}</span></div>
Â  Â  Â  Â  Â  Â <div class="attempt-box at-wrong">âŒ Wrong<span>${totalWrong}</span></div>
Â  Â  Â  Â  Â  Â <div class="attempt-box at-unattempted">ğŸŸ¡ Left<span>${totalQuestionsCount - attempted}</span></div>
Â  Â  Â  Â  Â  Â <div class="attempt-box at-total">âœï¸ Attempted<span>${attempted}</span></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:center">
Â  Â  Â  Â  Â  Â <button class="btn-dash btn-solid" style="width:100%; max-width:400px;" onclick="refreshLatestRankOnDemand(this)">ğŸ”„ GET LIVE UPDATED RANK</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  ${sectionalTableHtml}

Â  Â  Â  Â  <div class="card-dashboard" id="comparisonModule">
Â  Â  Â  Â  Â  <h3 class="section-title">ğŸ“Š You vs Topper (Complete Test)</h3>
Â  Â  Â  Â  Â  ${renderComparisonBar("Score", totalMarks, maxTotalMarks, topperStats.score, maxTotalMarks)}
Â  Â  Â  Â  Â  ${renderComparisonBar("Accuracy", accuracy, 100, topperStats.accuracy, 100, "%")}
Â  Â  Â  Â  Â  ${renderComparisonBar("Correct", totalCorrect, totalQuestionsCount, topperStats.correct, totalQuestionsCount)}
Â  Â  Â  Â  Â  ${renderComparisonBar("Wrong", totalWrong, totalQuestionsCount, topperStats.wrong, totalQuestionsCount, "", true)}
Â  Â  Â  Â  Â  ${renderComparisonBar("Time Taken", timeTakenSeconds, TOTAL_TIME_SECONDS, topperStats.time, TOTAL_TIME_SECONDS)}

Â  Â  Â  Â  Â  <div id="sectionalBarsContainer">
Â  Â  Â  Â  Â  Â  ${sectionalBarsHTML}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard">
Â  Â  Â  Â  Â  <h3 class="section-title">ğŸ† Top 10 Toppers(first attempt)</h3>
Â  Â  Â  Â  Â  <div style="overflow-x:auto">
Â  Â  Â  Â  Â  Â  <table class="topper-table">
Â  Â  Â  Â  Â  Â  Â  <tr><th>Rank</th><th>Name</th><th>Score</th><th>Time</th></tr>
Â  Â  Â  Â  Â  Â  Â  ${toppersList.map((t, idx) => `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${idx === 0 ? 'ğŸ¥‡' : (idx === 1 ? 'ğŸ¥ˆ' : (idx === 2 ? 'ğŸ¥‰' : '#' + (idx + 1)))}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${t.score}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${fmt(t.timeTaken)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`;

Â  Â  Â  resBox.innerHTML = dashboardHTML;
Â  Â  Â  resBox.style.display = "block";

Â  Â  Â  // ğŸ”§ format Time Taken bars (section + total)
resBox.querySelectorAll(".bar-section").forEach(sec => {
Â  const label = sec.querySelector(".bar-label span")?.textContent;
Â  if (label === "Time Taken") {
Â  Â  const values = sec.querySelectorAll("span[style*='text-align:right']");
Â  Â  values.forEach(val => {
Â  Â  Â  const raw = val.textContent.trim();
Â  Â  Â  if (!isNaN(raw) && raw !== "") {
Â  Â  Â  Â  val.textContent = fmt(parseInt(raw));
Â  Â  Â  }
Â  Â  });
Â  }
});

Â  Â  Â Â 
Â  Â  Â Â 

Â  Â  Â  LAST_RESULT_HTML = dashboardHTML;
Â  Â  Â  localStorage.setItem(QUIZ_RESULT_KEY, JSON.stringify({
Â  Â  Â  Â  submitted: true,
Â  Â  Â  Â  resultHTML: dashboardHTML,
Â  Â  Â  Â  answers,
Â  Â  Â  Â  marked,
Â  Â  Â  Â  current: 0,
Â  Â  Â  Â  sectionalData: sectionalDataForFirebase,
Â  Â  Â  Â  totalMarks,
Â  Â  Â  Â  timeTakenSeconds,
Â  Â  Â  Â  firebasePayloadÂ 
Â  Â  Â  }));

Â  Â  Â  normalizeMathForQuiz(resBox);
Â  Â  Â  renderMath();
Â  Â  });
Â  });
}
function autoSubmitQuiz() {
Â  // Prevent double submit
Â  if (!isQuiz) return;

Â  clearInterval(timerInterval);

Â 
Â  isQuiz = false;

Â  // Inform user (optional)
Â  alert("Time is up! Your test has been submitted automatically.");

Â  // Submit quiz silently
Â  submitQuiz(true); // true = auto submit
}
// ===============================
// ğŸ“Š FIREBASE & DATA FUNCTIONS
// ===============================


// 1. Save Result (uses email as unique folder)
function saveResultFirebase(payload) {
Â  const ref = db.ref("quiz_results/" + payload.quizId + "/" + USER_EMAIL_KEY);
Â  return ref.once("value").then(snap => {
Â  Â  if (snap.exists()) return false;Â 
Â  Â  return ref.set(payload);
Â  });
}

// 2. Save History
function saveAttemptHistory(payload) {
Â  const ref = db.ref("attempt_history/" + payload.quizId + "/" + USER_EMAIL_KEY + "/" + payload.submittedAt);
Â  return ref.set(payload);
}
// 3. Calculate Rank & Percentile (Enhanced for Sectional Support)
function getRankAndPercentile(quizId, myScore, myTime, mySubmittedAt) {
Â  return db.ref("attempt_history/" + quizId).once("value").then(snapshot => {
Â  Â  const data = snapshot.val() || {};
Â  Â  let attempts = [];

Â  Â  // Flatten all attempts
Â  Â  Object.values(data).forEach(deviceData => {
Â  Â  Â  Object.values(deviceData).forEach(att => attempts.push(att));
Â  Â  });

Â  Â  // Sort: Score DESC, Time ASC
Â  Â  attempts.sort((a, b) => {
Â  Â  Â  if (b.score !== a.score) return b.score - a.score;
Â  Â  Â  return a.timeTaken - b.timeTaken;
Â  Â  });

Â  Â  const total = attempts.length;
Â  Â  let rank = total + 1;Â 

Â  Â  // Find my rank
Â  Â  for (let i = 0; i < attempts.length; i++) {
Â  Â  Â  if (attempts[i].score === myScore &&
Â  Â  Â  Â  Â  attempts[i].timeTaken === myTime &&
Â  Â  Â  Â  Â  attempts[i].submittedAt === mySubmittedAt) {
Â  Â  Â  Â  rank = i + 1;
Â  Â  Â  Â  break;
Â  Â  Â  }
Â  Â  }

Â  Â  // Calculate Percentile
Â  Â  const below = attempts.filter(a =>
Â  Â  Â  a.score < myScore || (a.score === myScore && a.timeTaken > myTime)
Â  Â  ).length;

Â  Â  const percentile = total ? ((below / total) * 100).toFixed(2) : "0.00";

Â  Â  return { rank, percentile, total };
Â  });
}

// 4. Fetch Top 10 List
function getToppersList(quizId) {
Â  return db.ref("quiz_results/" + quizId).once("value").then(snapshot => {
Â  Â  const data = snapshot.val();
Â  Â  if (!data) return [];

Â  Â  let all = Object.values(data);
Â  Â  // Sort: Score High->Low, Time Low->High
Â  Â  all.sort((a, b) => {
Â  Â  Â  if (b.score !== a.score) return b.score - a.score;
Â  Â  Â  return a.timeTaken - b.timeTaken;
Â  Â  });

Â  Â  return all.slice(0, 10);
Â  });
}

// 5. Get Topper Stats for Bar Chart (Updated for Sectional scaling)
function getTopperStatsForComparison(toppersList, totalQ) {
Â  if (!toppersList || toppersList.length === 0) {
Â  Â  return { score: 0, accuracy: 0, correct: 0, wrong: 0, time: 0, sections: {} };
Â  }
Â  const t = toppersList[0]; // Rank 1 Topper
Â  const att = (t.correct || 0) + (t.wrong || 0);
Â  const acc = att > 0 ? ((t.correct / att) * 100).toFixed(1) : 0;

Â  return {Â 
Â  Â  score: t.score,Â 
Â  Â  accuracy: acc,Â 
Â  Â  correct: t.correct,Â 
Â  Â  wrong: t.wrong,Â 
Â  Â  time: t.timeTaken,
Â  Â  sections: t.sections || {} // NEW: Include topper's sectional breakdown
Â  };
}

// 6. Render Comparison Bar HTML (Deto same as before, used for Total and Sections)
function renderComparisonBar(label, userVal, maxVal, topperVal, maxTopperVal, unit = "", isReverse = false) {
Â  const userPct = (userVal > 0) ? Math.min(100, (userVal / maxVal) * 100) : 0;
Â  const topperPct = (topperVal > 0) ? Math.min(100, (topperVal / maxTopperVal) * 100) : 0;

Â  return `
Â  <div class="bar-section">
Â  Â  <div class="bar-label"><span>${label}</span></div>

Â  Â  <div style="display:grid; grid-template-columns: 60px 1fr 80px; gap:10px; align-items:center; margin-bottom:6px;">
Â  Â  Â  Â  <span style="font-size:12px; font-weight:700; color:var(--accent);">YOU</span>
Â  Â  Â  Â  <div class="bar-track"><div class="bar-fill fill-you" style="width:${userPct}%"></div></div>
Â  Â  Â  Â  <span style="font-size:12px; font-weight:700; text-align:right;">${userVal}${unit}</span>
Â  Â  </div>

Â  Â  <div style="display:grid; grid-template-columns: 60px 1fr 80px; gap:10px; align-items:center;">
Â  Â  Â  Â  <span style="font-size:12px; font-weight:700; color:var(--success);">TOPPER</span>
Â  Â  Â  Â  <div class="bar-track"><div class="bar-fill fill-topper" style="width:${topperPct}%"></div></div>
Â  Â  Â  Â  <span style="font-size:12px; font-weight:700; text-align:right;">${topperVal}${unit}</span>
Â  Â  </div>
Â  </div>`;
}
function resetForSolutionMode() {

Â  // âŒ do absolutely nothing if quiz is still running
Â  if (isQuiz) return;

Â  // âœ… always start from first section
Â  currentSectionIdx = 0;
Â  current = 0;
Â  QUESTIONS = SECTIONS[SECTION_NAMES[0]];

}

// ===============================
// ğŸ® DASHBOARD INTERACTIONS
// ===============================

// Enter "Detailed Solution" Mode (Testbook Style)

function enterSolutionMode() {
Â  // 1. Switch Flags
Â  isQuiz = false;
Â  Â  resetForSolutionMode();
Â  document.body.classList.add("mode-solution");
Â  document.body.classList.remove("mode-quiz");
Â Â 
Â  // ... rest of your code stays exactly the same
Â Â 

Â  Â  Â  // 7. ğŸ”¥ REBUILD AND RE-RENDER (The Fix)
Â  buildPalette();Â  Â  Â  // Re-creates the 1, 2, 3... buttons
Â  updatePaletteLegend();
Â  highlightPalette();Â  // Apply Red/Green colors to the new buttons
Â  renderQuestion(0);Â  Â // Show first question

Â  // 2. Hide Dashboard & Other Result Views
Â  document.getElementById("results").style.display = "none";
Â  document.getElementById("previousAttempts").style.display = "none";
Â  document.getElementById("attemptReplay").style.display = "none";

Â  // 3. Prepare the Quiz Container
Â  const quizArea = document.getElementById("quizMainArea");
Â  const header = document.getElementById("mainHeader");
Â  const palette = document.getElementById("palette"); // Targeted palette
Â  if (el("sectionNav")) el("sectionNav").style.display = "flex";
Â Â 
Â  header.style.display = "block";
Â  palette.style.display = "flex"; // Ensure palette container is visible

Â  // 4. Header UI Adjustments
Â  document.getElementById("backToAnalysisBtn").style.display = "inline-block";
Â  document.getElementById("timer").style.display = "none";
Â  document.getElementById("submitBtn").style.display = "none";
Â  document.getElementById("headerTitle").textContent = "Solution Mode";

Â  // 5. Layout Restoration (Critical for the "nothing showing" issue)
Â  if (window.innerWidth >= 992) {
Â  Â  Â  quizArea.style.display = "grid";
Â  Â  Â  // Re-organize desktop buttons
Â  Â  Â  const topActions = document.getElementById("topActions");
Â  Â  Â  topActions.appendChild(document.getElementById("prevBtn"));
Â  Â  Â  topActions.appendChild(document.getElementById("clearBtn"));
Â  Â  Â  topActions.appendChild(document.getElementById("markBtn"));
Â  Â  Â  topActions.appendChild(document.getElementById("nextBtn"));
Â  Â  Â  document.getElementById("floatBar").style.display = "none";
Â  } else {
Â  Â  Â  quizArea.style.display = "block";
Â  Â  Â  document.getElementById("floatBar").style.display = "flex";
Â  Â  Â  palette.style.display = "none"; // Hide mobile palette until "View" clicked
Â  }

Â  // 6. Fix Button Visibility
Â  document.getElementById("clearBtn").style.display = "none";
Â  document.getElementById("markBtn").style.display = "none";
Â  attachListeners();Â  Â // Re-links the clicks

Â  // 8. Refresh Math Rendering
Â  if (window.MathJax) {
Â  Â  MathJax.typesetPromise();
Â  }
}


// Reattempt (Clear and Reload)
function reattemptQuiz() {
Â  if(confirm("Are you sure you want to reattempt? Your current progress in this session will be reset.")) {
Â  Â  localStorage.removeItem(QUIZ_RESULT_KEY);
Â  Â  localStorage.removeItem(QUIZ_STATE_KEY);
Â  Â  localStorage.removeItem('ssc_quiz_name'); // âœ… Add this to clear the name for the new attempt
Â  Â  window.location.reload();
Â  }
}

// Restore Dashboard (From History/Solution Mode)
function restoreLatestResult() {
Â  if(LAST_RESULT_HTML) {
Â  Â  // ğŸ”´ CRITICAL FIX: analysis page must NEVER show section buttons
Â  Â  const sNav = document.getElementById("sectionNav");
Â  Â  if (sNav) sNav.style.display = "none";
Â  Â Â 
Â  Â  document.getElementById("results").innerHTML = LAST_RESULT_HTML;
Â  Â  document.getElementById("results").style.display = "block";
Â  Â  // ğŸ”“ Re-enable Live Rank button after restore (CRITICAL)
const liveBtn = document.querySelector(
Â  "button[onclick*='refreshLatestRankOnDemand']"
);
if (liveBtn) {
Â  liveBtn.disabled = false;
Â  liveBtn.textContent = "ğŸ”„ GET LIVE UPDATED RANK";
}


Â  Â  // Hide other views
Â  Â  document.getElementById("quizMainArea").style.display = "none";
Â  Â  document.getElementById("previousAttempts").style.display = "none";
Â  Â  document.getElementById("mainHeader").style.display = "none";
Â  Â  document.getElementById("floatBar").style.display = "none";
Â  }
}
// Enhanced: Powerful Live Updated Rank (Fixed Reload Logic)
async function refreshLatestRankOnDemand(btn) {
Â  const resultData = JSON.parse(localStorage.getItem(QUIZ_RESULT_KEY));
Â  if (!resultData || !resultData.firebasePayload || !resultData.answers) {
Â  Â  alert("No submission data found to update.");
Â  Â  return;
Â  }

Â  btn.disabled = true;
Â  btn.textContent = "Updating All Parts...";

Â const urlParams = new URLSearchParams(window.location.search);
Â  const quizIdParam = urlParams.get('id');

Â  if (!quizIdParam) {
Â  Â  document.getElementById("loadingText").innerHTML = "Error: No Quiz ID provided in URL.<br><small>Example: ?id=Rajuhari</small>";
Â  Â  return;
Â  }

Â Â 
Â  Â  try {
Â  Â  // --- 1. GET ACCESS TOKEN FROM SUPABASE ---
Â  Â  const { data: { session } } = await _supabase.auth.getSession();
Â  Â  const token = session ? session.access_token : null;

Â  Â  // --- 2. CONFIGURE PATHS ---
Â  Â  const GATEKEEPER_URL = "https://gatekeeper-api.sscjourney2official.workers.dev/";Â 
Â  Â  const GITHUB_PATH = "ssc/cgl/full-mock";Â 

Â  Â  // --- 3. ADD AUTHORIZATION HEADER ---
Â  Â  const headers = { "Accept": "application/json" };
Â  Â  if (token) {
Â  Â  Â  Â  headers["Authorization"] = `Bearer ${token}`;Â 
Â  Â  }

Â  Â  const response = await fetch(`${GATEKEEPER_URL}?id=${quizIdParam}&path=${GITHUB_PATH}`, {
Â  Â  Â  method: 'GET',
Â  Â  Â  headers: headers
Â  Â  });
Â  Â Â 
Â  Â  if (!response.ok) throw new Error("Quiz file not found or Access Denied.");
Â  Â Â 
Â  Â  const data = await response.json();

Â Â 
Â  Â Â 
Â  Â  // 2. Re-Calculation Loop: Re-evaluate answers against new JSON keys
Â  Â  let newTotalCorrect = 0, newTotalWrong = 0, newTotalMarks = 0, newMaxTotalMarks = 0;
Â  Â  const newSectionalData = {};
Â  Â  const freshSections = freshData.sections;
Â  Â  const freshNames = Object.keys(freshSections);

Â  Â  freshNames.forEach(name => {
Â  Â  Â  let sCor = 0, sWr = 0, sScore = 0, sMax = 0;
Â  Â  Â  freshSections[name].forEach(q => {
Â  Â  Â  Â  const qCorScore = Number(q.correct_score ?? freshData.meta.correct_score ?? 2);
Â  Â  Â  Â  const qNegScore = Number(q.negative_score ?? freshData.meta.negative_score ?? 0.5);
Â  Â  Â  Â  sMax += qCorScore;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userAns = resultData.answers[q.id];
Â  Â  Â  Â  if (userAns) {
Â  Â  Â  Â  Â  if (String(userAns) === String(q.answer)) {
Â  Â  Â  Â  Â  Â  sCor++; sScore += qCorScore;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sWr++; sScore -= qNegScore;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  const oldTime = resultData.firebasePayload.sections?.[name]?.timeTaken || 0;
Â  Â  Â  newSectionalData[name] = {
Â  Â  Â  Â  score: sScore, total: sMax, correct: sCor, wrong: sWr,
Â  Â  Â  Â  unattempted: freshSections[name].length - (sCor + sWr),
Â  Â  Â  Â  timeTaken: oldTime
Â  Â  Â  };
Â  Â  Â  newTotalCorrect += sCor; newTotalWrong += sWr;
Â  Â  Â  newTotalMarks += sScore; newMaxTotalMarks += sMax;
Â  Â  });

Â  Â  // 3. Firebase Sync: Update BOTH results and history so rank remains accurate
Â  Â  const fbUpdate = {
Â  Â  Â  score: newTotalMarks,
Â  Â  Â  correct: newTotalCorrect,
Â  Â  Â  wrong: newTotalWrong,
Â  Â  Â  sections: newSectionalData
Â  Â  };

Â  Â  // Change these lines:
await db.ref("quiz_results/" + QUIZ_ID + "/" + USER_EMAIL_KEY).update(fbUpdate);
await db.ref("attempt_history/" + QUIZ_ID + "/" + USER_EMAIL_KEY + "/" + resultData.firebasePayload.submittedAt).update(fbUpdate);

Â  Â  // Define payload with updated values for UI rendering
Â  Â  const payload = {
Â  Â  Â  ...resultData.firebasePayload,
Â  Â  Â  score: newTotalMarks,
Â  Â  Â  total: newMaxTotalMarks,
Â  Â  Â  correct: newTotalCorrect,
Â  Â  Â  wrong: newTotalWrong,
Â  Â  Â  sections: newSectionalData
Â  Â  };

Â  Â  const resultsContainer = document.getElementById("results");
Â  Â  const scorePerQ = Number(freshData.meta.correct_score) || 2;
Â  Â  const totalQuestionsCount = payload.total / scorePerQ;

Â  Â  // 1. Update Latest Global Total Rank
Â  Â  const totalRank = await getRankAndPercentile(
Â  Â  Â  QUIZ_ID,
Â  Â  Â  payload.score,
Â  Â  Â  payload.timeTaken,
Â  Â  Â  payload.submittedAt
Â  Â  );
Â  Â Â 
Â  Â  // 4. UI Refresh: Update Score Summary and Attempt Summary Boxes
Â  Â  const scoreItems = document.querySelectorAll(".score-item p");
Â  Â  if(scoreItems.length >= 3) {
Â  Â  Â  scoreItems[0].textContent = `${totalRank.rank} / ${totalRank.total}`;
Â  Â  Â  scoreItems[1].textContent = `${totalRank.percentile}%`;
Â  Â  Â  scoreItems[2].textContent = `${payload.score} / ${payload.total}`;
Â  Â  }
Â  Â Â 
Â  Â  const attBoxes = document.querySelectorAll(".attempt-box span");
Â  Â  if(attBoxes.length >= 4) {
Â  Â  Â  attBoxes[0].textContent = payload.correct;
Â  Â  Â  attBoxes[1].textContent = payload.wrong;
Â  Â  Â  attBoxes[2].textContent = (freshData.meta.total_questions || totalQuestionsCount) - (payload.correct + payload.wrong);
Â  Â  Â  attBoxes[3].textContent = payload.correct + payload.wrong;
Â  Â  }

Â  Â  // UPDATE: Sectional Summary Table Rows
Â  Â  const analysisTable = resultsContainer.querySelector(".analysis-table");
Â  Â  if (analysisTable) {
Â  Â  Â  const rows = analysisTable.querySelectorAll("tr");
Â  Â  Â  freshNames.forEach(name => {
Â  Â  Â  Â  const d = newSectionalData[name];
Â  Â  Â  Â  // Find row by section name text
Â  Â  Â  Â  for (let row of rows) {
Â  Â  Â  Â  Â  if (row.cells[0] && row.cells[0].textContent.trim() === name) {
Â  Â  Â  Â  Â  Â  row.cells[1].textContent = d.score;
Â  Â  Â  Â  Â  Â  row.cells[2].textContent = d.correct;
Â  Â  Â  Â  Â  Â  row.cells[3].textContent = d.wrong;
Â  Â  Â  Â  Â  Â  row.cells[4].textContent = d.unattempted;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // 2. Fetch Topper Data
Â  Â  const toppersList = await getToppersList(QUIZ_ID);
Â  Â  const topperStats = getTopperStatsForComparison(toppersList, totalQuestionsCount);

Â  Â  // 3. Calculate local variables needed for the bars
Â  Â  const totalAttempted = payload.correct + payload.wrong;
Â  Â  const accuracy = totalAttempted > 0Â 
Â  Â  Â  Â  ? ((payload.correct / totalAttempted) * 100).toFixed(2)Â 
Â  Â  Â  Â  : "0.00";

Â  Â  // 4. Update Comparison Bars
Â  Â  const mainBars = Array.from(resultsContainer.querySelectorAll(".section-title"))
Â  Â  Â  .find(el => el.textContent.includes("Complete Test"))?.closest(".card-dashboard");

Â  Â  if (mainBars) {
Â  Â  Â  let secBarsHTML = "";
Â  Â  Â  const namesToProcess = (freshNames && freshNames.length > 0) ? freshNames : Object.keys(payload.sections || {});

Â  Â  Â  namesToProcess.forEach(name => {
Â  Â  Â  Â  const mySec = payload.sections[name];
Â  Â  Â  Â  if (!mySec) return;

Â  Â  Â  Â  const topperSecRaw = topperStats.sections?.[name] || {};
Â  Â  Â  Â  const topperSec = {
Â  Â  Â  Â  Â  score: topperSecRaw.score || 0,
Â  Â  Â  Â  Â  correct: topperSecRaw.correct || 0,
Â  Â  Â  Â  Â  wrong: topperSecRaw.wrong || 0,
Â  Â  Â  Â  Â  timeTaken: topperSecRaw.timeTaken || 0
Â  Â  Â  Â  };

Â  Â  Â  Â  const myAttempted = mySec.correct + mySec.wrong;
Â  Â  Â  Â  const topperAttempted = topperSec.correct + topperSec.wrong;
Â  Â  Â  Â  const myAcc = myAttempted ? ((mySec.correct / myAttempted) * 100).toFixed(2) : "0.00";
Â  Â  Â  Â  const topperAcc = topperAttempted ? ((topperSec.correct / topperAttempted) * 100).toFixed(2) : "0.00";

Â  Â  Â  Â  secBarsHTML += `
Â  Â  Â  Â  Â  <h4 class="section-title" style="margin-top:25px; border-left:4px solid var(--accent); padding-left:10px;">
Â  Â  Â  Â  Â  Â  Part: ${name}
Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  ${renderComparisonBar("Score", mySec.score, mySec.total, topperSec.score, mySec.total)}
Â  Â  Â  Â  Â  ${renderComparisonBar("Accuracy", myAcc, 100, topperAcc, 100, "%")}
Â  Â  Â  Â  Â  ${renderComparisonBar("Correct", mySec.correct, mySec.total / scorePerQ, topperSec.correct, mySec.total / scorePerQ)}
Â  Â  Â  Â  Â  ${renderComparisonBar("Wrong", mySec.wrong, mySec.total / scorePerQ, topperSec.wrong, mySec.total / scorePerQ, "", true)}
Â  Â  Â  Â  Â  ${renderComparisonBar("Time Taken", mySec.timeTaken, TOTAL_TIME_SECONDS || 3600, topperSec.timeTaken, TOTAL_TIME_SECONDS || 3600)}
Â  Â  Â  Â  `;
Â  Â  Â  });

Â  Â  Â  mainBars.innerHTML = `
Â  Â  Â  Â  <h3 class="section-title">ğŸ“Š You vs Topper (Complete Test)</h3>
Â  Â  Â  Â  ${renderComparisonBar("Score", payload.score, payload.total, topperStats.score, payload.total)}
Â  Â  Â  Â  ${renderComparisonBar("Accuracy", accuracy, 100, topperStats.accuracy, 100, "%")}
Â  Â  Â  Â  ${renderComparisonBar("Correct", payload.correct, totalQuestionsCount, topperStats.correct, totalQuestionsCount)}
Â  Â  Â  Â  ${renderComparisonBar("Wrong", payload.wrong, totalQuestionsCount, topperStats.wrong, totalQuestionsCount, "", true)}
Â  Â  Â  Â  ${renderComparisonBar("Time Taken", payload.timeTaken, TOTAL_TIME_SECONDS || 3600, topperStats.time, TOTAL_TIME_SECONDS || 3600)}
Â  Â  Â  Â  <div id="sectionalBarsContainer">${secBarsHTML}</div>
Â  Â  Â  `;
Â  Â  Â  formatTimeValues(mainBars);
Â  Â  }

Â  Â  const topperCard = resultsContainer.querySelector(".topper-table")?.closest(".card-dashboard");
Â  Â  if (topperCard) {
Â  Â  Â  topperCard.innerHTML = `
Â  Â  Â  Â  <h3 class="section-title">ğŸ† Top 10 Toppers (First Attempt)</h3>
Â  Â  Â  Â  <div style="overflow-x:auto">
Â  Â  Â  Â  Â  <table class="topper-table">
Â  Â  Â  Â  Â  Â  <tr><th>Rank</th><th>Name</th><th>Score</th><th>Time</th></tr>
Â  Â  Â  Â  Â  Â  ${toppersList.map((t, idx) => `
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${idx === 0 ? 'ğŸ¥‡' : (idx === 1 ? 'ğŸ¥ˆ' : (idx === 2 ? 'ğŸ¥‰' : '#' + (idx + 1)))}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${t.score}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${fmt(t.timeTaken)}</td>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `).join("")}
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  }

Â  Â  // 5. Storage Overwrite: Save updated HTML so changes persist on reload
Â  Â  LAST_RESULT_HTML = resultsContainer.innerHTML;
Â  Â  localStorage.setItem(QUIZ_RESULT_KEY, JSON.stringify({
Â  Â  Â  ...resultData,
Â  Â  Â  firebasePayload: payload,
Â  Â  Â  resultHTML: LAST_RESULT_HTML
Â  Â  }));

Â  Â  alert("All Ranks and Comparison Bars updated to the latest data!");
Â  } catch (err) {
Â  Â  console.error("Live Update Error:", err);
Â  Â  alert("Could not update ranks. Please check your connection.");
Â  } finally {
Â  Â  btn.disabled = false;
Â  Â  btn.textContent = "ğŸ”„ GET LIVE UPDATED RANK";
Â  }
}
Â 
// Helper to fix the time formatting in bars
function formatTimeValues(container) {
Â  container.querySelectorAll(".bar-section").forEach(sec => {
Â  Â  const label = sec.querySelector(".bar-label span")?.textContent;
Â  Â  if (label === "Time Taken") {
Â  Â  Â  const values = sec.querySelectorAll("span[style*='text-align:right']");
Â  Â  Â  values.forEach(val => {
Â  Â  Â  Â  const raw = val.textContent.replace('%', '').trim();
Â  Â  Â  Â  if (!isNaN(raw) && raw !== "") {
Â  Â  Â  Â  Â  val.textContent = fmt(parseInt(raw));
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  });
}
Â 
// ===============================
// ?? HISTORY & ATTEMPT REVIEW
// ===============================

// Load list of past attempts
function loadPreviousAttempts(quizId) {
Â  const box = document.getElementById("previousAttempts");
Â  box.innerHTML = '<div style="text-align:center; padding:20px;">Loading history...</div>';
Â  box.style.display = "block";

Â  // Hide other views
Â  document.getElementById("results").style.display = "none";
Â  document.getElementById("attemptReplay").style.display = "none";

Â  // USE THE GLOBAL USER_EMAIL_KEY
Â  db.ref("attempt_history/" + quizId + "/" + USER_EMAIL_KEY)
Â  Â  .once("value")
Â  Â  .then(snapshot => {
Â  Â  Â  const data = snapshot.val();
Â  Â  Â  if (!data) {
Â  Â  Â  Â  box.innerHTML = '<div class="card"><p style="text-align:center">No previous attempts found.</p><button class="btn-dash btn-outline" style="width:100%" onclick="restoreLatestResult()">â¬… Back</button></div>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Sort by date (Newest first)
Â  Â  Â  const attempts = Object.values(data).sort((a, b) => b.submittedAt - a.submittedAt);

Â  Â  Â  let html = `<div class="card-dashboard">
Â  Â  Â  Â  <h3 class="section-title">ğŸ“‚ Attempt History</h3>
Â  Â  Â  Â  <div style="display:flex; flex-direction:column; gap:10px;">`;

Â  Â  Â  attempts.forEach((a, i) => {
Â  Â  Â  Â  const date = new Date(a.submittedAt).toLocaleDateString();
Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  <div style="background:#f8f9fa; padding:12px; border:1px solid #eee; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:700; color:#333;">Attempt ${attempts.length - i}</div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-size:12px; color:#666;">${date} â€¢ Score: ${a.score}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn-ghost" onclick='showAttempt(${JSON.stringify(a)})'>View Analysis</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  });

Â  Â  Â  html += `</div><div style="margin-top:15px"><button class="btn-dash btn-outline" style="width:100%" onclick="restoreLatestResult()">â¬… Back to Latest Result</button></div></div>`;

Â  Â  Â  box.innerHTML = html;
Â  Â  });
}

// Render Analysis Dashboard for a Past Attempt
function showAttempt(attempt) {
Â  const box = document.getElementById("attemptReplay");
Â  box.innerHTML = '<div style="text-align:center; padding:20px;">Loading analysis...</div>';
Â  box.style.display = "block";
Â  document.getElementById("previousAttempts").style.display = "none";

Â  // Fetch Rank for this old attempt
Â  getRankAndPercentile(QUIZ_ID, attempt.score, attempt.timeTaken, attempt.submittedAt)
Â  Â  .then(rankData => {

Â  Â  Â  // Calculate Stats
Â  Â  Â  const totalQ = QUESTIONS.length;
Â  Â  Â  // Note: We don't have full topper list for past dates easily, so we skip Topper Comparison bars for history
Â  Â  Â  // or use current topper data as reference (using current toppers for simplicity)

Â  Â  Â  let dashboardHTML = `
Â  Â  Â  <div class="analysis-container">
Â  Â  Â  Â  <div class="card-dashboard">
Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  <div><b>Attempt Date:</b> ${new Date(attempt.submittedAt).toLocaleString()}</div>
Â  Â  Â  Â  Â  Â  <div><b>Quiz ID:</b> ${QUIZ_ID}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard">
Â  Â  Â  Â  Â  Â <div class="action-grid">
Â  Â  Â  Â  Â  Â  Â  <button class="btn-dash btn-outline" onclick="loadPreviousAttempts(QUIZ_ID)">â¬… Back to History</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-dash btn-outline" onclick="restoreLatestResult()">ğŸ  Latest Result</button>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard score-summary">
Â  Â  Â  Â  Â  <div class="score-item"><h4>ğŸ† Rank</h4><p>${rankData.rank} / ${rankData.total}</p></div>
Â  Â  Â  Â  Â  <div class="score-item"><h4>ğŸ“Š Percentile</h4><p>${rankData.percentile}%</p></div>
Â  Â  Â  Â  Â  <div class="score-item"><h4>ğŸ§® Score</h4><p>${attempt.score} / ${attempt.total}</p></div>
Â  Â  Â  Â  Â  <div class="score-item"><h4>â± Time</h4><p>${fmt(attempt.timeTaken)}</p></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-dashboard attempt-summary">
Â  Â  Â  Â  Â  Â <div class="attempt-box at-correct">âœ… Correct<span>${attempt.correct}</span></div>
Â  Â  Â  Â  Â  Â <div class="attempt-box at-wrong">âŒ Wrong<span>${attempt.wrong}</span></div>
Â  Â  Â  Â  Â  Â <div class="attempt-box at-unattempted">ğŸŸ¡ Left<span>${totalQ - (attempt.correct + attempt.wrong)}</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`;

Â  Â  Â  box.innerHTML = dashboardHTML;
Â  Â  });
}

// ===============================
// ğŸ® UI INTERACTIONS & LISTENERS
// ===============================

function attachListeners(){


Â  // âœ… ADD THIS BLOCK (Fixes Back to Analysis Button)
Â  const backAnaBtn = document.getElementById("backToAnalysisBtn");
Â  if(backAnaBtn) {
Â  Â  backAnaBtn.addEventListener("click", () => {
Â  Â  Â  Â restoreLatestResult();
Â  Â  Â Â 
Â  Â  });
Â  }



Â  // Navigation
Â  el("nextBtn").onclick = () => { if(current < QUESTIONS.length-1) renderQuestion(current+1); };
Â  el("prevBtn").onclick = () => { if(current > 0) renderQuestion(current-1); };
Â  el("clearBtn").onclick = () => {
Â  Â  if(!isQuiz) return;
Â  Â  delete answers[QUESTIONS[current].id ?? current];
Â  Â  renderQuestion(current);
Â  };

Â  // Mark for Review
Â  el("markBtn").onclick = () => {
Â  Â  const qid = QUESTIONS[current].id ?? current;
Â  Â  if(marked[qid]) delete marked[qid];
Â  Â  else marked[qid] = true;
Â  Â  highlightPalette(); // Update color
Â  Â  renderQuestion(current); // Update button state if needed
Â  };

Â  // Palette Toggle (Mobile)
Â  el("paletteBtn").onclick = (e) => {
Â  Â  e.stopPropagation();
Â  Â  const pal = el("palette");
Â  Â  if(pal.style.display === "flex" || pal.style.display === "block") {
Â  Â  Â  Â  // Hide
Â  Â  Â  Â  if(window.innerWidth < 992) pal.style.display = "none";
Â  Â  } else {
Â  Â  Â  Â  // Show
Â  Â  Â  Â  pal.style.display = "flex";
Â  Â  Â  Â  highlightPalette();
Â  Â  Â  Â  updatePaletteLegend();
Â  Â  }
Â  };

Â  // Close Palette when clicking outside (Mobile)
Â  document.addEventListener("click", (e) => {
Â  Â  if(window.innerWidth >= 992) return; // Ignore on Desktop
Â  Â  const pal = el("palette");
Â  Â  const btn = el("paletteBtn");
Â  Â  if(pal.style.display === "flex" && !pal.contains(e.target) && e.target !== btn) {
Â  Â  Â  pal.style.display = "none";
Â  Â  }
Â  });

Â  // Submit Modal
Â  // Submit Modal with Sectional Table
el("submitBtn").onclick = () => {
Â  Â  let modalTableHtml = `
Â  Â  Â  <div style="overflow-x:auto; margin-top:15px;">
Â  Â  Â  Â  <table style="width:100%; border-collapse: collapse; font-size: 12px; text-align: left; border: 1px solid #ddd;">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr style="background-color: #f2f2f2;">
Â  Â  Â  Â  Â  Â  Â  <th style="padding: 8px; border: 1px solid #ddd;">Section</th>
Â  Â  Â  Â  Â  Â  Â  <th style="padding: 8px; border: 1px solid #ddd;">Att.</th>
Â  Â  Â  Â  Â  Â  Â  <th style="padding: 8px; border: 1px solid #ddd;">Left</th>
Â  Â  Â  Â  Â  Â  Â  <th style="padding: 8px; border: 1px solid #ddd;">Marked</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody>`;

Â  Â  let totalQuestionsInQuiz = 0;
Â  Â  let totalAttempted = 0;
Â  Â  let totalMarked = 0;

Â  Â  SECTION_NAMES.forEach(name => {
Â  Â  Â  const sectionQuestions = SECTIONS[name];
Â  Â  Â  let att = 0, markedCount = 0;

Â  Â  Â  // Sum the total number of questions
Â  Â  Â  totalQuestionsInQuiz += sectionQuestions.length;Â 

Â  Â  Â  sectionQuestions.forEach(q => {
Â  Â  Â  Â  if (answers[q.id]) att++;
Â  Â  Â  Â  if (marked[q.id]) markedCount++;
Â  Â  Â  });

Â  Â  Â  const left = sectionQuestions.length - att;
Â  Â  Â Â 
Â  Â  Â  // Update overall totals
Â  Â  Â  totalAttempted += att;
Â  Â  Â  totalMarked += markedCount;

Â  Â  Â  modalTableHtml += `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd;"><b>${name}</b></td>
Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd; color: var(--success);">${att}</td>
Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd; color: var(--danger);">${left}</td>
Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd; color: var(--accent);">${markedCount}</td>
Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  const totalLeft = totalQuestionsInQuiz - totalAttempted;

Â  Â  modalTableHtml += `
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  <tfoot>
Â  Â  Â  Â  Â  Â  <tr style="background-color: #f9f9f9; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd;">Total</td>
Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd; color: var(--success);">${totalAttempted}</td>
Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd; color: var(--danger);">${totalLeft}</td>
Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd; color: var(--accent);">${totalMarked}</td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  <tr style="background-color: #eee; font-weight: 800; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  <td colspan="4" style="padding: 10px; border: 1px solid #ddd;">
Â  Â  Â  Â  Â  Â  Â  Â  Overall: ${totalAttempted} / ${totalQuestionsInQuiz} Attempted
Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </tfoot>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>`;

Â  Â  el("submitMsg").innerHTML = `<div style="text-align:center; font-weight:700; margin-bottom:10px;">Exam Summary</div>` + modalTableHtml;
Â  Â  el("submitModal").style.display = "flex";
};
Â Â 
Â  el("cancelSubmit").onclick = () => el("submitModal").style.display = "none";
Â  el("confirmSubmit").addEventListener("click", ()=> { el("submitModal").style.display = "none"; submitQuiz(); });
}
// Build Palette Buttons
function buildPalette() {
Â  const pal = el("palette");
Â Â 
Â  // Re-structure palette to include legend, SECTION LABEL, grid, and fixed submit button
Â  pal.innerHTML = `
Â  Â  <div id="palette-legend"></div>
Â  Â  <div id="palSectionLabel" style="background:#fff; padding:6px; margin-bottom:10px; text-align:center; font-weight:800; border:1px solid #ccc; font-size:12px; color:#333;"></div>
Â  Â  <div id="palette-summary" style="margin-bottom:10px; font-weight:700; font-size:13px; text-align:center;"></div>
Â  Â  <div id="palette-grid" class="palette-grid" style="overflow-y:auto; flex-grow:1;"></div>
Â  Â  <div class="palette-submit-container" id="palSubmitArea" style="padding:10px 0; border-top:1px solid #ccc; background:#dae5f0; text-align:center;">
Â  Â  Â  <button id="palSubmitBtn" class="btn" style="width:95%; background:#1a73e8; color:white; font-weight:700; padding:12px; border-radius:4px; border:none; cursor:pointer;">Submit Test</button>
Â  Â  </div>
Â  `;

Â  // NEW: Update Section Label inside Palette
Â  const sName = SECTION_NAMES[currentSectionIdx] || "";
Â  el("palSectionLabel").textContent = sName.toUpperCase();

Â  const grid = el("palette-grid");
Â  grid.innerHTML = "";
Â Â 
Â  // UPDATED: Numbering restarts from 1 because QUESTIONS is now scoped to the active section array
Â  QUESTIONS.forEach((q, i) => {
Â  Â  const btn = document.createElement("button");
Â  Â  btn.className = "qbtn notvisited";
Â  Â  btn.textContent = i + 1;Â 
Â  Â  btn.onclick = () => {
Â  Â  Â  renderQuestion(i);
Â  Â  Â  if (window.innerWidth < 992) el("palette").style.display = "none";
Â  Â  };
Â  Â  grid.appendChild(btn);
Â  });

Â  // Attach submit event to the new button
Â  el("palSubmitBtn").onclick = () => {
Â  Â  if (isQuiz) {
Â  Â  Â  Â  el('submitBtn').click(); // Triggers your existing submit logic/modal
Â  Â  } else {
Â  Â  Â  Â  restoreLatestResult(); // If in solution mode, goes back to analysis
Â  Â  }
Â  };

Â  updatePaletteLegend();
}

// Update Palette Colors
function highlightPalette() {
Â  const btns = document.querySelectorAll(".qbtn");
Â  if (btns.length === 0) return;

Â  btns.forEach((btn, i) => {
Â  Â  const qid = QUESTIONS[i].id ?? i;
Â  Â  btn.className = "qbtn"; // Reset

Â  Â  if (current === i) btn.classList.add("current");

Â  Â  if (isQuiz) {
Â  Â  Â  if (marked[qid]) {
Â  Â  Â  Â  btn.classList.add(answers[qid] ? "marked-answered" : "marked");
Â  Â  Â  } else if (answers[qid]) {
Â  Â  Â  Â  btn.classList.add("answered");
Â  Â  Â  } else {
Â  Â  Â  Â  btn.classList.add("notvisited");
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  const myAns = answers[qid];
Â  Â  Â  const correctAns = String(QUESTIONS[i].answer);
Â  Â  Â  if (!myAns) {
Â  Â  Â  Â  btn.classList.add("sol-skip");
Â  Â  Â  } else if (String(myAns) === correctAns) {
Â  Â  Â  Â  btn.classList.add("sol-right");
Â  Â  Â  } else {
Â  Â  Â  Â  btn.classList.add("sol-wrong");
Â  Â  Â  }
Â  Â  Â  if (marked[qid]) btn.classList.add("has-star");
Â  Â  }
Â  });

Â  // Handle the Submit Button Visibility inside palette
Â  const palSubmitBtn = el("palSubmitBtn");
Â  if (palSubmitBtn) {
Â  Â  if (isQuiz) {
Â  Â  Â  Â  palSubmitBtn.textContent = "Submit Test";
Â  Â  } else {
Â  Â  Â  Â  palSubmitBtn.textContent = "Back to Analysis";
Â  Â  }
Â  }

Â  const curQid = QUESTIONS[current].id ?? current;
Â  const mkBtn = el("markBtn");
Â  if (mkBtn) {
Â  Â  if (marked[curQid]) {
Â  Â  Â  mkBtn.textContent = "Unmark Review";
Â  Â  Â  mkBtn.classList.add("active-mark");
Â  Â  } else {
Â  Â  Â  mkBtn.textContent = "Mark for Review";
Â  Â  Â  mkBtn.classList.remove("active-mark");
Â  Â  }
Â  }
Â  updatePaletteLegend();
}

// update function - NOW WITH SECTIONAL SUMMARY
function updatePaletteLegend() {
Â  const legend = document.getElementById("palette-legend");
Â  const summary = document.getElementById("palette-summary");
Â  if (!legend || !summary) return;

Â  if (isQuiz) {
Â  Â  legend.innerHTML = `
Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:12px; margin-bottom:10px;">
Â  Â  Â  Â  <div><span class="lg-box notvisited" style="background:#bdbdbd"></span> Not Visited</div>
Â  Â  Â  Â  <div><span class="lg-box answered" style="background:var(--success)"></span> Answered</div>
Â  Â  Â  Â  <div><span class="lg-box marked" style="background:var(--accent)"></span> Marked</div>
Â  Â  Â  Â  <div><span class="lg-box marked-answered" style="background:var(--accent)">â˜…</span> Ans & Marked</div>
Â  Â  Â  </div>
Â  Â  `;

Â  Â  // NEW: Calculate counts ONLY for questions in the current active section
Â  Â  let s_answered = 0, s_notAnswered = 0, s_markedOnly = 0, s_markedAnswered = 0;
Â  Â Â 
Â  Â  QUESTIONS.forEach((q) => {
Â  Â  Â  const qid = q.id;
Â  Â  Â  const hasAnswer = !!answers[qid];
Â  Â  Â  const isMarked = !!marked[qid];
Â  Â  Â Â 
Â  Â  Â  if (hasAnswer && isMarked) s_markedAnswered++;
Â  Â  Â  else if (hasAnswer) s_answered++;
Â  Â  Â  else if (isMarked) s_markedOnly++;
Â  Â  Â  else s_notAnswered++;
Â  Â  });

Â  Â  summary.innerHTML = `
Â  Â  Â  <div style="border-top:1px solid #ccc; padding-top:8px; color:#555; font-size:12px;">
Â  Â  Â  Â  <b>Section Summary:</b><br>
Â  Â  Â  Â  Ans: <span style="color:var(--success)">${s_answered}</span> |Â 
Â  Â  Â  Â  Left: <span style="color:var(--danger)">${s_notAnswered}</span> |Â 
Â  Â  Â  Â  Marked: <span style="color:var(--accent)">${s_markedOnly + s_markedAnswered}</span>
Â  Â  Â  </div>
Â  Â  `;
Â  } else {
Â  Â  legend.innerHTML = `
Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; font-size:12px; margin-bottom:10px;">
Â  Â  Â  Â  <div><span class="lg-box" style="background:var(--success)"></span> Correct</div>
Â  Â  Â  Â  <div><span class="lg-box" style="background:var(--danger)"></span> Wrong</div>
Â  Â  Â  Â  <div><span class="lg-box" style="background:#9e9e9e"></span> Skipped</div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â Â 
Â  Â  let s_correct = 0, s_wrong = 0, s_skipped = 0;
Â  Â  QUESTIONS.forEach((q) => {
Â  Â  Â  const qid = q.id;
Â  Â  Â  const myAns = answers[qid];
Â  Â  Â  if (!myAns) s_skipped++;
Â  Â  Â  else if (String(myAns) === String(q.answer)) s_correct++;
Â  Â  Â  else s_wrong++;
Â  Â  });
Â  Â Â 
Â  Â  summary.innerHTML = `
Â  Â  Â  <div style="border-top:1px solid #ccc; padding-top:8px; color:#555; font-size:12px;">
Â  Â  Â  Â  <b>Section Results:</b><br>
Â  Â  Â  Â  Correct: ${s_correct} | Wrong: ${s_wrong} | Skipped: ${s_skipped}
Â  Â  Â  </div>
Â  Â  `;
Â  }
}
// ===============================
// ğŸš€ INITIALIZATION
// ===============================


Â  function init() {
Â Â 
Â  if (typeof getLocalProfile !== "function") {
Â  Â  Â  console.error("Auth script not loaded yet!");
Â  Â  Â  setTimeout(init, 500); // Retry in half a second
Â  Â  Â  return;
Â  }
Â 
Â  // 1. Get User Data from Auth Cache
Â  const profile = getLocalProfile(); // This is the function in your auth.js
Â Â 
Â  if (!profile) {
Â  Â  Â  // If no profile, they aren't logged in. Redirect to login.
Â  Â  Â  window.location.href = "/login.html";
Â  Â  Â  return;
Â  }

Â  // 2. Set the global identifiers
Â  USER_DISPLAY_NAME = profile.username;
Â  // Firebase keys cannot have dots, so we change test@gmail.com to test@gmail,com
Â  USER_EMAIL_KEY = profile.email.replace(/\./g, ',');Â 

Â  // 3. Update UI
Â  const userBox = el("headerUsername");
Â  if(userBox) userBox.textContent = USER_DISPLAY_NAME;

Â 
Â  // 1. CHECK IF ALREADY SUBMITTED (Static Result Page)
Â  const resultSaved = localStorage.getItem(QUIZ_RESULT_KEY);
Â  if (resultSaved) {
Â  Â  const data = JSON.parse(resultSaved);
Â  Â  if (data.submitted && data.resultHTML) {
Â  Â  Â  isQuiz = false; // <--- âœ… ADD THIS LINE HERE
Â  Â  Â  updatePaletteLegend();
Â  Â  Â  // Hide Welcome & Quiz
Â  Â  Â  answers = data.answers || {};
Â  Â  Â  markedÂ  = data.markedÂ  || {};
Â  Â  Â  current = data.current || 0;
Â  Â  Â  el("welcomeScreen").style.display = "none";
Â  Â  Â  el("mainHeader").style.display = "none";
Â  Â  Â  el("quizMainArea").style.display = "none";
Â  Â  Â  el("floatBar").style.display = "none";
Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â // Show Result
Â  Â  Â  const res = document.getElementById("results");
Â  Â  Â  res.innerHTML = data.resultHTML;
Â  Â  Â  res.style.display = "block";
Â  Â  Â  LAST_RESULT_HTML = data.resultHTML;
Â  Â  Â  // ğŸ”“ CRITICAL FIX: Re-enable Live Rank button after reload restore
setTimeout(() => {
Â  const liveBtn = document.querySelector(
Â  Â  "button[onclick*='refreshLatestRankOnDemand']"
Â  );
Â  if (liveBtn) {
Â  Â  liveBtn.disabled = false;
Â  Â  liveBtn.textContent = "ğŸ”„ GET LIVE UPDATED RANK";
Â  }
}, 0);


Â  Â  Â  // ğŸ”§ FIX: Restore mm:ss format in bars after reload
Â  Â  Â  res.querySelectorAll(".bar-section").forEach(sec => {
Â  Â  Â  Â  const label = sec.querySelector(".bar-label span")?.textContent;
Â  Â  Â  Â  if (label === "Time Taken") {
Â  Â  Â  Â  Â  const values = sec.querySelectorAll("span[style*='text-align:right']");
Â  Â  Â  Â  Â  values.forEach(val => {
Â  Â  Â  Â  Â  Â  const rawText = val.textContent.replace('%', '').trim();
Â  Â  Â  Â  Â  Â  if(!isNaN(rawText) && rawText !== "") {
Â  Â  Â  Â  Â  Â  Â  val.textContent = fmt(parseInt(rawText));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â }
Â  Â  }

Â  // 2. RESTORE PROGRESS (Resume Quiz)
Â  const savedName = localStorage.getItem("ssc_quiz_name");
Â  const nameInput = document.getElementById("studentName");

Â  if (nameInput) {
Â  Â  // Only restore if it's a real name and NOT the default "Student"
Â  Â  if (savedName && savedName !== "Student") {
Â  Â  Â  nameInput.value = savedName;
Â  Â  } else {
Â  Â  Â  nameInput.value = ""; // âœ… Clear it so validation triggers
Â  Â  }
Â  }
Â  Â  // --- UPDATE STEP 2 INSIDE init() ---
const stateSaved = localStorage.getItem(QUIZ_STATE_KEY);
if (stateSaved) {
Â  const state = JSON.parse(stateSaved);
Â  current = state.current ?? 0;
Â  answers = state.answers ?? {};
Â  marked = state.marked ?? {};
Â  seconds = state.seconds ?? seconds;
Â Â 
Â  // RESTORE SECTION PERSISTENCE
Â  if (state.currentSectionIdx !== undefined) {
Â  Â  currentSectionIdx = state.currentSectionIdx;
Â  }
Â Â 
Â  // RESTORE LANGUAGE PERSISTENCE HERE
Â  if (state.currentLang) {
Â  Â  currentLang = state.currentLang;
Â  Â  const headerLangSelect = el("langSelect");
Â  Â  if (headerLangSelect) headerLangSelect.value = currentLang;
Â  }
}


Â  if (isQuiz && SECTION_NAMES.length > 0) {
Â  Â  Â  switchSection(currentSectionIdx);
Â  Â  Â  if (stateSaved) {
Â  Â  Â  Â  Â  const state = JSON.parse(stateSaved);
Â  Â  Â  Â  Â  current = state.current ?? 0;
Â  Â  Â  }
Â  }

Â  renderQuestion(current);
Â  buildPalette();
Â  updatePaletteLegend();
Â  highlightPalette();
Â  renderMath();
Â Â 
Â  // ğŸ”¥ FINAL STEP: Attach listeners only ONCE at the very end
Â  attachListeners();Â 
}


// ğŸš¦ START BUTTON LISTENER
document.getElementById("welcomeStartBtn").addEventListener("click", function() {
Â  const selected = document.getElementById("welcomeLangSelect").value;
Â  const isChecked = document.getElementById("instrConfirm").checked;
Â  if (!selected) {
Â  Â  alert("Please select a language! / à¤•à¥ƒà¤ªà¤¯à¤¾ à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥‡à¤‚!");
Â  Â  return; // STOP: Button won't work without selection
Â  }
Â  if (!isChecked) {
Â  Â  alert("Please confirm that you have read the instructions.");
Â  Â  return;
Â  }

Â  // Set persistence
Â  currentLang = selected;
Â  document.getElementById("langSelect").value = selected; // Sync header dropdown

Â  // Proceed to quiz
Â  document.getElementById("welcomeScreen").style.display = "none";
Â  document.getElementById("mainHeader").style.display = "block";
Â Â 
Â  // SHOW Section Navigation
Â  const sNav = el("sectionNav");
Â  if(sNav) sNav.style.display = "flex";
Â 
Â  document.body.classList.add("mode-quiz");
Â  document.body.classList.remove("mode-solution");

Â  const quizArea = document.getElementById("quizMainArea");
Â  if(window.innerWidth >= 992) {
Â  Â  Â  quizArea.style.display = "grid";
Â  } else {
Â  Â  Â  quizArea.style.display = "block";
Â  Â  Â  document.getElementById("floatBar").style.display = "flex";
Â  }
Â Â 
Â  // Start with the first section
Â  switchSection(0);
Â Â 
Â  startTimer();
Â  renderQuestion(current);
});

// ğŸ”„ STARTUP SCRIPT
document.addEventListener("DOMContentLoaded", function () {
Â  Â  loadQuizData();Â 
Â  SECURITY.init();
});


// ===============================
// ğŸŒ DYNAMIC FETCH LOGIC (With Auto-Resume)
// ===============================


async function loadQuizData() {
Â  const profile = getLocalProfile();
Â  if (profile) {
Â  Â  Â  // Change 'profiles' to 'profile' and add fallbacks
Â  Â  Â  USER_DISPLAY_NAME = profile.username || profile.name || "Guest";
Â  Â  Â  USER_EMAIL_KEY = (profile.email || "guest").replace(/\./g, ',');Â 
Â  }
Â  // ... rest of the code
Â  const urlParams = new URLSearchParams(window.location.search);
Â  const quizIdParam = urlParams.get('id');

Â  if (!quizIdParam) {
Â  Â  document.getElementById("loadingText").innerHTML = "Error: No Quiz ID provided in URL.";
Â  Â  return;
Â  }

Â  try {
Â  Â  // --- 1. GET ACCESS TOKEN FROM SUPABASE ---
Â  Â  const { data: { session } } = await _supabase.auth.getSession();
Â  Â  const token = session ? session.access_token : null;

Â  Â  // --- 2. CONFIGURE PATHS ---
Â  Â  const GATEKEEPER_URL = "https://gatekeeper-api.sscjourney2official.workers.dev/";Â 
Â  Â  const GITHUB_PATH = "ssc/cgl/full-mock";Â 

Â  Â  // --- 3. ADD AUTHORIZATION HEADER ---
Â  Â  const headers = { "Accept": "application/json" };
Â  Â  if (token) {
Â  Â  Â  Â  headers["Authorization"] = `Bearer ${token}`;Â 
Â  Â  }

Â  Â  const response = await fetch(`${GATEKEEPER_URL}?id=${quizIdParam}&path=${GITHUB_PATH}`, {
Â  Â  Â  method: 'GET',
Â  Â  Â  headers: headers
Â  Â  });
Â  Â Â 
Â  Â  // Handle specific error codes from your Worker
Â  Â  if (response.status === 402) throw new Error("Upgrade Required: You need a Premium Plan for this test.");
Â  Â  if (response.status === 401) throw new Error("Invalid Session: Please log in again.");
Â  Â  if (!response.ok) throw new Error("Quiz file not found or Access Denied.");
Â  Â Â 
Â  Â  const data = await response.json();

Â  Â  // 2. Assign Global Variables
Â  Â  QUIZ_TITLE = data.meta.title;
Â  Â  QUIZ_ID = data.meta.id;
Â  Â  Â Â 
QUIZ_STATE_KEY = "state_" + USER_EMAIL_KEY + "_" + QUIZ_ID;
QUIZ_RESULT_KEY = "result_" + USER_EMAIL_KEY + "_" + QUIZ_ID;


Â  Â  CORRECT_SCORE = data.meta.correct_score;
Â  Â  NEGATIVE_SCORE = data.meta.negative_score;
Â  Â  TOTAL_TIME_SECONDS = data.meta.timer_seconds;
Â  Â  Â Â 
Â  Â  // Set initial seconds
Â  Â  seconds = data.meta.timer_seconds;

Â  Â  // SECTIONAL LOGIC HANDLING
Â  Â  SECTIONS = data.sections;Â 
Â  Â  SECTION_NAMES = Object.keys(SECTIONS);
Â  Â  // FIX: Initialize QUESTIONS immediately so renderQuestion doesn't crash on reload
Â  Â  QUESTIONS = SECTIONS[SECTION_NAMES[0]];Â 


Â 
Â  Â  // 4. Build Section Buttons (Modified to show PART A, PART B...)
Â  Â  const nav = document.getElementById("sectionNav");
Â  Â  if(nav) {
Â  Â  Â  nav.innerHTML = "";
Â  Â  Â  SECTION_NAMES.forEach((name, i) => {
Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  btn.className = "sec-btn" + (i === 0 ? " active" : "");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // This logic converts index 0 to 'A', 1 to 'B', etc.
Â  Â  Â  Â  const partLabel = "PART " + String.fromCharCode(65 + i);Â 
Â  Â  Â  Â  btn.textContent = partLabel;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // The click still uses the index to load the real section data
Â  Â  Â  Â  btn.onclick = () => switchSection(i);
Â  Â  Â  Â  nav.appendChild(btn);
Â  Â  Â  });
Â  Â  }

Â  Â  // --- Updated Logic for Sectional Summary ---
Â  Â  let welcomeTableHtml = "";
Â  Â  let totalQuestionsCount = 0;

Â  Â  // Use SECTION_NAMES to loop through your "Section A", "Section B" keys
Â  Â  SECTION_NAMES.forEach(name => {
Â  Â  Â  const sectionArray = SECTIONS[name]; // Gets the list of questions for this section
Â  Â  Â  const sectionCount = sectionArray.length;
Â  Â  Â  totalQuestionsCount += sectionCount;
Â  Â  Â Â 
Â  Â  Â  welcomeTableHtml += `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <td style="padding: 10px; border: 1px solid #ddd;"><b>${name}</b></td>
Â  Â  Â  Â  Â  <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${sectionCount}</td>
Â  Â  Â  Â  Â  <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--success);">+${CORRECT_SCORE}</td>
Â  Â  Â  Â  Â  <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: var(--danger);">${NEGATIVE_SCORE}</td>
Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  // 1. Fill the Table Body
Â  Â  const tableBody = document.getElementById("welcomeSectionTableBody");
Â  Â  if (tableBody) tableBody.innerHTML = welcomeTableHtml;

Â  Â  // 2. Fill the Table Footer with Totals
Â  Â  const tableFoot = document.getElementById("welcomeSectionTableFoot");
Â  Â  if (tableFoot) {
Â  Â  Â  tableFoot.innerHTML = `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
Â  Â  Â  Â  Â  <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${totalQuestionsCount}</td>
Â  Â  Â  Â  Â  <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">
Â  Â  Â  Â  Â  Â  Time: ${data.meta.timer_minutes} Mins
Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
Â  Â  }

Â  Â  // 3. Fix the "Total Question" information box at the top
Â  Â  const totalQBox = document.getElementById("disp_totalQ");
Â  Â  if (totalQBox) totalQBox.textContent = totalQuestionsCount;


Â  Â  // 5. Update UI Texts
Â  Â  document.title = QUIZ_TITLE;
Â  Â  document.getElementById("headerTitle").textContent = QUIZ_TITLE;
Â  Â  document.getElementById("disp_quizTitle").textContent = QUIZ_TITLE;
Â  Â  document.getElementById("disp_quizId").textContent = QUIZ_ID;
Â  Â Â 
Â  Â  document.getElementById("disp_correct").textContent = "+" + CORRECT_SCORE;
Â  Â  document.getElementById("disp_negative").textContent = "-" + NEGATIVE_SCORE;
Â  Â  document.getElementById("disp_time").textContent = data.meta.timer_minutes;

Â  Â  // 6. Hide Loader
Â  Â  document.getElementById("loadingOverlay").style.display = "none";

Â  Â  // 7. Run Initialization
Â  Â  init();

Â  Â  // 8. ğŸ”¥ FIXED AUTO-RESUME LOGIC ğŸ”¥
Â  Â  const savedState = localStorage.getItem(QUIZ_STATE_KEY);
Â  Â  const alreadySubmitted = localStorage.getItem(QUIZ_RESULT_KEY);

Â  Â  if (savedState && !alreadySubmitted) {
Â  Â  Â  const state = JSON.parse(savedState);
Â  Â  Â  // ONLY resume if the timer has actually started (seconds < total time)
Â  Â  Â  if (state.seconds < TOTAL_TIME_SECONDS) {
Â  Â  Â  Â  console.log("Resuming active session...");
Â  Â  Â  Â  currentSectionIdx = state.currentSectionIdx || 0;

Â  Â  Â  Â  document.getElementById("welcomeScreen").style.display = "none";
Â  Â  Â  Â  document.getElementById("mainHeader").style.display = "block";
Â  Â  Â  Â  if(el("sectionNav")) el("sectionNav").style.display = "flex";
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.body.classList.add("mode-quiz");
Â  Â  Â  Â  const quizArea = document.getElementById("quizMainArea");
Â  Â  Â  Â  if(window.innerWidth >= 992) {
Â  Â  Â  Â  Â  Â  quizArea.style.display = "grid";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  quizArea.style.display = "block";
Â  Â  Â  Â  Â  Â  document.getElementById("floatBar").style.display = "flex";
Â  Â  Â  Â  }

Â  Â  Â  Â  switchSection(currentSectionIdx);Â 
Â  Â  Â  Â  startTimer();
Â  Â  Â  }
Â  Â  }

Â  } catch (error) {
Â  Â  console.error(error);
Â  Â  document.getElementById("loadingText").innerHTML = `Error loading quiz.<br><small>${error.message}</small>`;
Â  }
}
// ğŸ›¡ï¸ PROTECTION SCRIPT
(function () {
Â  // Disable right click
Â  document.addEventListener("contextmenu", e => e.preventDefault());

Â  // Disable shortcuts (C, V, X, U, F12)
Â  document.addEventListener("keydown", function (e) {
Â  Â  if (e.key === "F12" ||
Â  Â  Â  Â (e.ctrlKey && ["u","s","p","c","v","x"].includes(e.key.toLowerCase()))) {
Â  Â  Â  e.preventDefault();
Â  Â  }
Â  });

Â  // Watermark Integrity Check
Â  setInterval(() => {
Â  Â  const wm = document.getElementById("ssc-watermark");
Â  Â  if(!wm || wm.style.display === "none" || wm.style.opacity === "0") {
Â  Â  Â  Â document.body.innerHTML = "Security Violation: Watermark Tampered";
Â  Â  }
Â  }, 3000);
})();
// ================= SECURITY (MERGED) =================
const SECURITY = {
Â  tabSwitchCount: 0,
Â  maxTabSwitches: 3,
Â  devToolsWarned: false,

Â  init() {
Â  Â  this.detectTabSwitch();
Â  Â  this.detectDevTools();
Â  Â  this.disablePrint();
Â  Â  this.disableDragDrop();
Â  },

Â  detectTabSwitch() {
Â  Â  document.addEventListener("visibilitychange", () => {
Â  Â  Â  if (document.hidden && isQuiz) {
Â  Â  Â  Â  this.tabSwitchCount++;
Â  Â  Â  Â  this.showWarning(
Â  Â  Â  Â  Â  `Tab switch detected (${this.tabSwitchCount}/${this.maxTabSwitches})`,
Â  Â  Â  Â  Â  this.tabSwitchCount >= this.maxTabSwitches ? "error" : "warning"
Â  Â  Â  Â  );

Â  Â  Â  Â  if (this.tabSwitchCount >= this.maxTabSwitches) {
Â  Â  Â  Â  Â  setTimeout(() => autoSubmitQuiz?.(), 1500);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  window.addEventListener("blur", () => {
Â  Â  Â  if (isQuiz) console.warn("Window lost focus");
Â  Â  });
Â  },

Â  detectDevTools() {
Â  Â  const threshold = 160;

Â  Â  const check = () => {
Â  Â  Â  const w = window.outerWidth - window.innerWidth > threshold;
Â  Â  Â  const h = window.outerHeight - window.innerHeight > threshold;
Â  Â  Â  if ((w || h) && !this.devToolsWarned) {
Â  Â  Â  Â  this.devToolsWarned = true;
Â  Â  Â  Â  this.showWarning("Developer tools detected!", "error");
Â  Â  Â  }
Â  Â  };

Â  Â  window.addEventListener("resize", check);
Â  Â  setInterval(check, 1000);

Â  Â  setInterval(() => {
Â  Â  Â  const t = performance.now();
Â  Â  Â  debugger;
Â  Â  Â  if (performance.now() - t > 100) {
Â  Â  Â  Â  this.showWarning("Debugger detected!", "error");
Â  Â  Â  }
Â  Â  }, 1000);
Â  },

Â  disablePrint() {
Â  Â  const style = document.createElement("style");
Â  Â  style.innerHTML = `
Â  Â  Â  @media print {
Â  Â  Â  Â  body * { display: none !important; }
Â  Â  Â  Â  body::after {
Â  Â  Â  Â  Â  content: "Printing is not allowed during exam.";
Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  padding: 50px;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  `;
Â  Â  document.head.appendChild(style);

Â  Â  window.print = () => this.showWarning("Printing disabled!", "error");
Â  },

Â  disableDragDrop() {
Â  Â  document.addEventListener("dragstart", e => e.preventDefault());
Â  Â  document.addEventListener("drop", e => e.preventDefault());
Â  },

Â  showWarning(msg, type="warning") {
Â  Â  const old = document.getElementById("secWarn");
Â  Â  if (old) old.remove();

Â  Â  const div = document.createElement("div");
Â  Â  div.id = "secWarn";
Â  Â  div.innerHTML = msg;
Â  Â  div.style = `
Â  Â  Â  position:fixed;top:20px;left:50%;
Â  Â  Â  transform:translateX(-50%);
Â  Â  Â  background:${type==="error"?"#fee2e2":"#fef3c7"};
Â  Â  Â  border:2px solid ${type==="error"?"#ef4444":"#f59e0b"};
Â  Â  Â  padding:12px 20px;border-radius:8px;
Â  Â  Â  font-weight:700;z-index:999999;
Â  Â  `;
Â  Â  document.body.appendChild(div);

Â  Â  setTimeout(() => div.remove(), 3000);
Â  }
};

</script>
</body>
</html>

